<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TYBCA Attendance Dashboard - Supabase</title>
  <style>
    :root{--panel:#ffffff;--accent:#0f9d58;--muted:#6b7280}
    .theme-login{--bg:radial-gradient(circle at top left,#7b2ff7,#5a2fd6,#5826c4,#7520b7,#9121b4,#b623b5,#d72ab8); }
    .theme-main{--bg:radial-gradient(circle at top left,#7b2ff7,#5a2fd6,#5826c4,#7520b7,#9121b4,#b623b5,#d72ab8);--accent:#0077ff}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:var(--bg);color:#111827;min-height:100vh;padding:16px;transition:background 0.4s ease}
    .login-wrapper{min-height:100vh;display:flex;align-items:center;justify-content:center}
    .login-card{width:100%;max-width:420px;background:#ffffff;border-radius:24px;box-shadow:0 18px 45px rgba(15,23,42,0.25);padding:24px 22px 20px;}
    .login-header{text-align:center;margin-bottom:16px}
    .login-header h1{font-size:22px;margin-top:6px;margin-bottom:4px}
    .login-header p{font-size:14px;color:var(--muted)}
    .login-label{font-size:14px;font-weight:600;margin-bottom:4px;color:#111827;display:block}
    .login-input,.login-select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb;font-size:14px;margin-bottom:10px}
    .login-input:focus,.login-select:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 1px rgba(59,130,246,0.4)}
    .login-btn{width:100%;margin-top:4px;padding:11px 12px;border-radius:999px;border:none;cursor:pointer;font-weight:600;font-size:15px;background:linear-gradient(135deg,#00c853,#009688);color:#fff;display:flex;align-items:center;justify-content:center;gap:8px}
    .info-box{margin-top:12px;padding:8px 10px;border-radius:12px;font-size:12px;background:#e0f2fe;border-left:4px solid #2563eb}
    .app-container{max-width:1200px;margin:0 auto;display:none}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;margin-top:4px}
    header h2{font-size:18px;color:#f9fafb;text-shadow:0 1px 3px rgba(15,23,42,0.8)}
    .top-right{display:flex;flex-direction:column;align-items:flex-end;gap:4px}
    .top-controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .top-controls input,.top-controls select{padding:7px 8px;border-radius:8px;border:1px solid #e5e7eb;font-size:13px;background:#fff}
    main{display:flex;gap:12px}
    .left{flex:2;display:flex;flex-direction:column;gap:12px}
    .right{flex:1;display:flex;flex-direction:column;gap:12px}
    .panel{background:rgba(255,255,255,0.96);border-radius:12px;padding:12px;box-shadow:0 4px 12px rgba(15,23,42,0.25);backdrop-filter:blur(8px)}
    h3.panel-title{margin-bottom:6px;font-size:15px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:6px 8px;border-bottom:1px solid #e5e7eb;text-align:left}
    thead th{background:#f9fafb;position:sticky;top:0;z-index:1}
    #usersTableWrap{max-height:260px;overflow:auto;margin-top:6px}
    #recordsWrap{max-height:260px;overflow:auto;margin-top:6px}
    #studentsReportWrap{max-height:220px;overflow:auto;margin-top:6px}
    #scanLogWrap{max-height:160px;overflow:auto;margin-top:6px}
    #facultySummaryWrap{max-height:260px;overflow:auto;margin-top:6px}
    .form-row{display:flex;align-items:center;gap:8px;margin:7px 0;font-size:13px}
    .form-row label{min-width:80px;color:#4b5563}
    input[type="text"],select,input[type="time"],input[type="email"],input[type="password"],input[type="number"]{padding:6px 8px;border-radius:8px;border:1px solid #e5e7eb;font-size:13px}
    button{background:var(--accent);color:#fff;padding:7px 10px;border-radius:8px;border:none;cursor:pointer;font-size:13px;display:inline-flex;align-items:center;gap:5px}
    button.secondary{background:#fff;color:#111827;border:1px solid #e5e7eb}
    button.download-btn-primary{background:#16a34a}
    button:disabled{opacity:0.55;cursor:not-allowed}
    .controls-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px}
    .summary p{font-size:13px;margin:2px 0}
    .stats-line{font-size:12px;color:#4b7280;margin:2px 0 4px}
    footer{text-align:center;margin-top:12px;font-size:11px;color:#e5e7eb}
    .alert{padding:9px 10px;margin-top:8px;background:#e6fffa;border-radius:10px;color:#065f46;font-size:13px;box-shadow:0 2px 6px rgba(16,185,129,0.25)}
    @media(max-width:900px){main{flex-direction:column}header{flex-direction:column;align-items:flex-start;gap:6px} .top-right{align-items:flex-start} .top-controls{justify-content:flex-start} #usersTableWrap{max-height:260px}}
    
    /* Modal */
    .att-modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:1100}
    .att-modal{width:calc(100% - 40px);max-width:760px;background:#fff;border-radius:12px;padding:16px;box-shadow:0 10px 30px rgba(2,6,23,0.35);max-height:80vh;overflow:auto}
    .att-modal-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px}
    .att-modal-title{font-size:16px;font-weight:700;color:#111827}
    .att-modal-sub{font-size:13px;color:#6b7280}
    .att-modal-close{background:#ef4444;color:#fff;padding:6px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .att-modal-list{margin-top:8px}
    .att-modal-list table{width:100%;border-collapse:collapse}
    .att-modal-list th,.att-modal-list td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:left;font-size:14px}
    .att-modal-empty{padding:18px;text-align:center;color:#6b7280}
    
    /* Action Buttons */
    .record-action { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; color:#111827; font-size:13px; cursor:pointer; box-shadow:0 1px 0 rgba(0,0,0,0.03); }
    .record-action.present { background:#ecfdf5; color:#065f46; border-color:#10b981; }
    .record-action.view { background:#f0f9ff; color:#0369a1; border-color:#0ea5e9; }
    .record-action.edit { background:#eef2ff; color:#3730a3; border-color:#a78bfa; }
    .record-action.delete { background:#fff1f2; color:#991b1b; border-color:#fca5a5; }
    .record-badge { display:inline-block; min-width:40px; padding:6px 10px; border-radius:999px; text-align:center; font-weight:700; background:linear-gradient(90deg,#f8fafc,#fff); color:#111827; border:1px solid #e6eef8; font-size:13px; }
    #recordsTable td .actions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    
    /* Heatmap & KPI */
    .heatmap-grid{display:grid;grid-template-columns: repeat(7, 1fr); gap:6px; padding:8px}
    .heatday{height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:11px;color:#0b1220;background:#e5e7eb}
    .heat-legend{display:flex;gap:6px;align-items:center;margin-top:6px;font-size:12px;flex-wrap:wrap}
    .kpi-row{display:flex;gap:8px;align-items:stretch}
    .kpi-card{flex:1;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#f8fafc);box-shadow:0 4px 12px rgba(2,6,23,0.06);display:flex;flex-direction:column;justify-content:center;gap:6px}
    .kpi-value{font-size:20px;font-weight:800}
    .kpi-label{font-size:12px;color:#6b7280}
    
    /* Password Toggle */
    .pwd-wrap{position:relative}
    .pwd-toggle{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:transparent;border:none;padding:6px;border-radius:6px;cursor:pointer;z-index:3;color:#6b7280;display:inline-flex;align-items:center;justify-content:center}
    .pwd-toggle svg{width:20px;height:20px;opacity:0.95;stroke:currentColor;fill:none}
    .pwd-toggle:focus{outline:2px solid rgba(59,130,246,0.35);box-shadow:0 0 0 3px rgba(59,130,246,0.12)}
    
    /* Timeline & Alerts */
    #timeline .timeline-item {display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .bar{height:10px;background:#f3f4f6;border-radius:999px;overflow:hidden}
    .bar-fill{height:100%;width:0%;background:#10b981;border-radius:999px}
    .alerts-list{list-style:none;padding:0;margin:0;max-height:220px;overflow:auto}
    .alerts-list li{padding:8px;border-radius:8px;background:#fff;margin-bottom:8px;border:1px solid #f1f5f9}
    .alerts-severity-low{color:#b91c1c;font-weight:700}

    /* Detail View Badges */
    .status-badge { font-weight:700; padding:4px 8px; border-radius:6px; font-size:12px; display:inline-block; }
    .status-badge.p { background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
    .status-badge.a { background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="theme-login">
  <div id="loginScreen" class="login-wrapper">
    <div class="login-card">
      <div class="login-header">
        <h2 style="text-transform:uppercase;font-size:22px;font-weight:800;margin-bottom:14px;color:#1f2937;letter-spacing:1.2px">DIGITAL ATTENDANCE TY-BCA 2025-26</h2>
        <div style="font-size:40px;margin-top:-4px">üîê</div>
        <h1>Admin / Faculty / Student Login</h1>
        <p>Enter your credentials to access</p>
      </div>

      <label class="login-label" for="loginEmail">Email</label>
      <input id="loginEmail" type="email" class="login-input" placeholder="Enter email" />
      <label class="login-label" for="loginPassword">Password</label>

      <div class="pwd-wrap">
        <input id="loginPassword" type="password" class="login-input" placeholder="Enter password" style="padding-right:52px" />
        <button id="pwdToggleBtn" class="pwd-toggle" aria-label="Show password" title="Show password" type="button"></button>
      </div>

      <button id="loginSubmit" class="login-btn"><span>üîí</span><span>Login</span></button>

      <div class="info-box">
        <div style="font-weight:600;margin-bottom:3px">Powered by Supabase</div>
        <div>Secure authentication and real-time database</div>
      </div>
    </div>
  </div>

  <div id="appContainer" class="app-container" aria-hidden="true">
    <header>
      <h2>TYBCA Attendance Dashboard</h2>
      <div class="top-right">
        <div class="top-controls">
          <input type="date" id="attendanceDate" />
          <select id="userType"><option value="student">Students</option><option value="faculty">Faculty</option></select>
          <input id="searchBox" placeholder="Search name or roll no" />
          <button id="logoutBtn" class="secondary">Logout</button>
        </div>
        <span id="roleLabel" style="font-size:12px;color:#f9fafb;background:rgba(15,23,42,0.35);padding:4px 8px;border-radius:999px"></span>
        <span id="connectionStatus" style="font-size:12px;color:#fff;background:#22c55e;padding:4px 8px;border-radius:999px">Connected to Supabase</span>
      </div>
    </header>

    <main>
      <section class="left">
        <div class="panel" id="userListPanel">
          <h3 class="panel-title">User List</h3>
          <div class="controls-row">
            <select id="sortSelect">
              <option value="">Sort / Filter</option><option value="roll-asc">Roll ‚Üë</option><option value="roll-desc">Roll ‚Üì</option><option value="name-asc">Name A‚ÜíZ</option><option value="present">Present</option><option value="absent">Absent</option>
            </select>
            <button id="selectAllBtn">Select All</button>
            <button id="clearAllBtn" class="secondary">Clear</button>
            <input id="scanInput" placeholder="Scan ID / Roll & press Enter" />
          </div>
          <div id="usersTableWrap">
            <table id="usersTable">
              <thead><tr><th>Roll</th><th>Name</th><th>Present</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="panel" id="lecturePanel">
          <h3 class="panel-title">Lecture / Session Details</h3>
          <div class="form-row"><label>Lecture</label><select id="lectureSelect"></select></div>
          <div class="form-row"><label>Type</label><select id="lectureType"><option value="Regular">Regular Lecture</option><option value="ProxyLecture">Proxy Lecture</option></select></div>
          <div class="form-row"><label>Start</label><input type="time" id="startTimeInput" /></div>
          <div class="form-row"><label>End</label><input type="time" id="endTimeInput" /></div>
          <div class="form-row"><label>Day</label><select id="daySelect"><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option>Saturday</option></select></div>
          <div class="form-row"><label>Faculty</label><select id="facultySelect"></select></div>
          <div class="form-row"><label><input type="checkbox" id="isProxy" /> Proxy?</label></div>
          <div id="proxyDetails" style="display:none"><div class="form-row"><label>Original</label><select id="originalFaculty"></select></div></div>
          <div class="form-row"><button id="submitAttendanceBtn">Submit Attendance</button><button id="cancelEditBtn" class="secondary" style="display:none">Cancel Edit</button></div>
        </div>

        <div id="dailyStatusPanel" class="panel">
          <h3 class="panel-title">Today's Attendance Status</h3>
          <div id="dailyStatusWrap" style="max-height:220px;overflow:auto;margin-top:8px">
            <table style="width:100%;border-collapse:collapse;font-size:13px">
              <thead>
                <tr>
                  <th>Roll</th>
                  <th>Name</th>
                  <th style="text-align:right">Status</th>
                </tr>
              </thead>
              <tbody id="dailyStatusBody"></tbody>
            </table>
          </div>
        </div>

        <div id="dailyPercentPanel" class="panel" data-panel="dailyPercentPanel">
          <h3 class="panel-title">Daily Percent (recent days)</h3>
          <div id="heatbarList" style="margin-top:8px"></div>
          <div class="heat-legend" style="margin-top:10px">
            <div class="heat-legend-item"><div style="width:16px;height:12px;background:#065f46;border-radius:3px"></div><div>90-100%</div></div>
            <div class="heat-legend-item"><div style="width:16px;height:12px;background:#10b981;border-radius:3px"></div><div>75-89%</div></div>
            <div class="heat-legend-item"><div style="width:16px;height:12px;background:#84cc16;border-radius:3px"></div><div>50-74%</div></div>
            <div class="heat-legend-item"><div style="width:16px;height:12px;background:#f59e0b;border-radius:3px"></div><div>25-49%</div></div>
            <div class="heat-legend-item"><div style="width:16px;height:12px;background:#f97316;border-radius:3px"></div><div>1-24%</div></div>
            <div class="heat-legend-item"><div style="width:16px;height:12px;background:#e5e7eb;border-radius:3px"></div><div>0%</div></div>
          </div>
        </div>

        <div id="detailsViewPanel" class="panel" style="display:none;">
          <h3 class="panel-title" id="detailsViewTitle">Selected Record Details</h3>
          <button id="closeDetailsBtn" class="secondary" style="margin-bottom:8px;font-size:12px">Close Details</button>
          <div id="detailsViewWrap" style="max-height:260px;overflow:auto;margin-top:6px">
            <table style="width:100%;border-collapse:collapse;font-size:13px">
              <thead>
                <tr><th>Roll</th><th>Name</th><th style="text-align:right">Status</th></tr>
              </thead>
              <tbody id="detailsViewBody"></tbody>
            </table>
          </div>
        </div>

        <div id="monthlyHeatPanel" class="panel" data-panel="monthlyHeatPanel">
          <h3 class="panel-title">Monthly Heatmap (grid) ‚Äî last 30 days</h3>
          <div id="heatmap" class="heatmap-grid" style="margin-top:8px"></div>
        </div>
      </section>

      <aside class="right">
        <div class="panel" id="todaySummaryPanel" data-panel="todaySummaryPanel">
          <h3 class="panel-title">Today's Summary</h3>
          <div class="summary"><p>Present today: <span id="presentCount">0</span></p><p>Absent today: <span id="absentCount">0</span></p><p>Lectures today: <span id="lecturesToday">0</span></p></div>
        </div>

        <div class="panel" id="scanLogPanel" data-panel="scanLogPanel">
          <h3 class="panel-title">Scan Log</h3>
          <div id="scanLogWrap">
            <table id="scanLogTable"><thead><tr><th>Time</th><th>Roll</th><th>Name</th><th>Lecture</th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <div class="panel" id="attendanceRecordsPanel" data-panel="attendanceRecordsPanel">
          <h3 class="panel-title">Attendance Records</h3>
          <div class="controls-row"><button id="downloadCSVBtn">Download CSV</button><button id="clearAllRecordsBtn" class="secondary">Delete All</button></div>
          <div id="recordsWrap">
            <table id="recordsTable">
              <thead><tr><th>Date</th><th>Time</th><th>Lecture</th><th>Faculty</th><th>Present</th><th>View</th><th>Edit</th><th>Delete</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="panel" id="analyticsPanel" data-panel="analyticsPanel">
          <h3 class="panel-title">Attendance Analytics</h3>
          <div class="summary"><p><strong>Regular Students (Today)</strong></p><p id="studentsStatsText" class="stats-line"></p></div>
          <canvas id="studentsPie" height="110"></canvas>
        </div>

        <div class="panel" id="overviewPanel">
          <h3 class="panel-title">Overview</h3>
          <div class="kpi-row" style="margin-top:8px">
            <div class="kpi-card">
              <div class="kpi-value" id="kpiAvg7d">--%</div>
              <div class="kpi-label">Avg attendance (7d)</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-value" id="kpiBestDay">--</div>
              <div class="kpi-label">Best day (30d)</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-value" id="kpiLecturesToday">0</div>
              <div class="kpi-label">Lectures today</div>
            </div>
          </div>

          <div style="display:flex;gap:8px;margin-top:12px;align-items:flex-start">
            <div style="flex:1;">
              <div style="font-size:13px;color:#6b7280;margin-bottom:6px">Attendance trend (7 days)</div>
              <canvas id="attendanceTrend" height="80"></canvas>
            </div>
            <div style="width:260px;">
              <div style="font-size:13px;color:#6b7280;margin-bottom:6px">Recent Alerts</div>
              <ul id="alertsList" class="alerts-list"></ul>
            </div>
          </div>
        </div>

        <div class="panel" id="facultySummaryPanel" data-panel="facultySummaryPanel">
          <h3 class="panel-title">Faculty Summary</h3>
          <div style="font-size:13px;color:#6b7280;margin-top:6px">Summary of lectures by faculty (total / regular / proxy)</div>
          <div id="facultySummaryWrap" style="margin-top:10px; overflow:auto; max-height:220px">
            <table id="facultySummaryTable" style="width:100%">
              <thead>
                <tr><th>Faculty</th><th style="text-align:right">Total</th><th style="text-align:right">Regular</th><th style="text-align:right">Proxy</th></tr>
              </thead>
              <tbody id="facultySummaryBody"></tbody>
            </table>
          </div>
        </div>

        <div class="panel" id="timelinePanel" data-panel="timelinePanel">
          <h3 class="panel-title">Today's Timeline</h3>
          <div id="timeline" style="margin-top:8px"></div>
        </div>

      </aside>
    </main>

    <footer>TY-BCA 2025-26 ‚Ä¢ Digital Attendance ‚Ä¢ Powered by Supabase</footer>
  </div>

  <div id="attModalBackdrop" class="att-modal-backdrop" aria-hidden="true">
    <div class="att-modal" role="dialog" aria-modal="true" aria-labelledby="attModalTitle">
      <div class="att-modal-header">
        <div>
          <div id="attModalTitle" class="att-modal-title">Attendance</div>
          <div id="attModalSubtitle" class="att-modal-sub">Details</div>
        </div>
        <div>
          <button id="attModalCloseBtn" class="att-modal-close">Close</button>
        </div>
      </div>
      <div id="attModalContent" class="att-modal-list"></div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://hunnkdhhacqwhpqxovte.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1bm5rZGhoYWNxd2hwcXhvdnRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MTI4MzIsImV4cCI6MjA3OTQ4ODgzMn0.MAGBD6youFiHbCVxCd_3sD4DMidEuVBFaoncj1RLxGk";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <script>
    (function(){
      // state
      let currentUser = null, currentRole = null, currentList = [], attendanceState = {}, records = [], students = [], faculty = [], lectures = [], studentsPieChart = null, trendChart = null, isEditing = false, currentEditRecordId = null, scanLog = [];

      // DOM refs
      const loginScreen = document.getElementById("loginScreen");
      const appContainer = document.getElementById("appContainer");
      const loginEmail = document.getElementById("loginEmail");
      const loginPassword = document.getElementById("loginPassword");
      const loginSubmit = document.getElementById("loginSubmit");
      const roleLabel = document.getElementById("roleLabel");
      const logoutBtn = document.getElementById("logoutBtn");
      const attendanceDate = document.getElementById("attendanceDate");
      const userTypeSel = document.getElementById("userType");
      const searchBox = document.getElementById("searchBox");
      const sortSelect = document.getElementById("sortSelect");
      const usersTableBody = document.querySelector("#usersTable tbody");
      const selectAllBtn = document.getElementById("selectAllBtn");
      const clearAllBtn = document.getElementById("clearAllBtn");
      const scanInput = document.getElementById("scanInput");
      const lectureSelect = document.getElementById("lectureSelect");
      const lectureTypeSelect = document.getElementById("lectureType");
      const startTimeInput = document.getElementById("startTimeInput");
      const endTimeInput = document.getElementById("endTimeInput");
      const daySelect = document.getElementById("daySelect");
      const facultySelect = document.getElementById("facultySelect");
      const originalFaculty = document.getElementById("originalFaculty");
      const isProxy = document.getElementById("isProxy");
      const proxyDetails = document.getElementById("proxyDetails");
      const submitBtn = document.getElementById("submitAttendanceBtn");
      const cancelEditBtn = document.getElementById("cancelEditBtn");
      const presentCountEl = document.getElementById("presentCount");
      const absentCountEl = document.getElementById("absentCount");
      const lecturesTodayEl = document.getElementById("lecturesToday");
      const recordsTableBody = document.querySelector("#recordsTable tbody");
      const downloadCSVBtn = document.getElementById("downloadCSVBtn");
      const clearAllRecordsBtn = document.getElementById("clearAllRecordsBtn");
      const studentsStatsText = document.getElementById("studentsStatsText");
      const scanLogTbody = document.querySelector("#scanLogTable tbody");

      // NEW DETAIL PANEL REFS
      const detailsViewPanel = document.getElementById('detailsViewPanel');
      const detailsViewTitle = document.getElementById('detailsViewTitle');
      const detailsViewBody = document.getElementById('detailsViewBody');
      const closeDetailsBtn = document.getElementById('closeDetailsBtn');

      // visual containers & new items
      const heatmapEl = document.getElementById("heatmap");
      const heatbarList = document.getElementById("heatbarList");
      const timelineEl = document.getElementById("timeline");
      const facultySummaryBody = document.getElementById("facultySummaryBody");
      const alertsList = document.getElementById("alertsList");
      const dailyStatusBody = document.getElementById("dailyStatusBody");

      // KPI & trend elements
      const kpiAvg7d = document.getElementById("kpiAvg7d");
      const kpiBestDay = document.getElementById("kpiBestDay");
      const kpiLecturesToday = document.getElementById("kpiLecturesToday");
      const trendCanvas = document.getElementById("attendanceTrend");

      // password toggle wiring
      const pwdToggleBtn = document.getElementById('pwdToggleBtn');
      const eyeIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M2 12s4-8 10-8 10 8 10 8-4 8-10 8S2 12 2 12z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
      const eyeOffIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M17.94 17.94A10.94 10.94 0 0 1 12 20c-6 0-10-8-10-8a18.65 18.65 0 0 1 5.11-7.03"></path><path d="M1 1l22 22"></path><path d="M9.88 9.88a3 3 0 0 0 4.24 4.24"></path></svg>`;

      // init
      async function init(){
        try {
          const { data:{session} } = await supabase.auth.getSession();
          if(session) await handleSessionUser(session.user);
        } catch(e){
          console.warn('auth getSession failed', e);
        }

        loginSubmit.addEventListener("click", handleLogin);
        loginPassword.addEventListener("keydown", e => { if(e.key==="Enter") handleLogin(); });
        logoutBtn.addEventListener("click", logout);
        userTypeSel.addEventListener("change", onUserTypeChange);
        searchBox.addEventListener("input", renderList);
        sortSelect.addEventListener("change", renderList);
        selectAllBtn.addEventListener("click", ()=>setAll(true));
        clearAllBtn.addEventListener("click", ()=>setAll(false));
        attendanceDate.addEventListener("change", ()=>{ updateSummary(); renderAllCharts(); renderHeatmap(); });
        isProxy.addEventListener("change", ()=>{ proxyDetails.style.display = isProxy.checked ? "block" : "none"; });
        submitBtn.addEventListener("click", submitAttendance);
        cancelEditBtn.addEventListener("click", ()=>exitEditMode(false));
        downloadCSVBtn.addEventListener("click", downloadCSV);
        clearAllRecordsBtn.addEventListener("click", clearAllRecords);
        scanInput.addEventListener("keydown", e => { if(e.key==="Enter"){ const code=scanInput.value.trim(); scanInput.value=""; handleScan(code); }});
        lectureSelect.addEventListener("change", updateTimeFromLecture);
        
        // Close detail panel
        closeDetailsBtn.addEventListener('click', () => {
            detailsViewPanel.style.display = 'none';
        });

        if(pwdToggleBtn){
          if(!pwdToggleBtn.innerHTML.trim()) pwdToggleBtn.innerHTML = eyeIcon;
          pwdToggleBtn.setAttribute('aria-label','Show password');
          pwdToggleBtn.title = 'Show password';
          pwdToggleBtn.addEventListener('click', ()=>{ togglePassword(); });
          pwdToggleBtn.addEventListener('keydown', e => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); togglePassword(); }});
        }

        document.getElementById('attModalCloseBtn').addEventListener('click', closeAttendanceModal);
        document.getElementById('attModalBackdrop').addEventListener('click', function(e){ if(e.target===this) closeAttendanceModal(); });

        attendanceDate.value = new Date().toISOString().slice(0,10);

        await loadStudents(); await loadFaculty(); await loadLectures(); await loadAttendanceRecords();
        populateLectures(); populateFacultySelects(); updateTimeFromLecture();
        userTypeSel.value = "student"; setUserListForType(); applyRolePermissions();
        updateSummary(); renderAllCharts(); renderHeatmap();
      }

      function togglePassword(){
        const isHidden = loginPassword.type === 'password';
        if(isHidden){
          loginPassword.type = 'text';
          pwdToggleBtn.innerHTML = eyeOffIcon;
          pwdToggleBtn.setAttribute('aria-label','Hide password');
          pwdToggleBtn.title = 'Hide password';
        } else {
          loginPassword.type = 'password';
          pwdToggleBtn.innerHTML = eyeIcon;
          pwdToggleBtn.setAttribute('aria-label','Show password');
          pwdToggleBtn.title = 'Show password';
        }
        pwdToggleBtn.focus();
      }

      async function handleLogin(){
        const email = loginEmail.value.trim(), password = loginPassword.value.trim();
        if(!email||!password){ showAlert("Please enter email and password"); return; }
        try{
          const { data, error } = await supabase.auth.signInWithPassword({ email, password });
          if(error) throw error;
          if(!data || !data.user) throw new Error('No user returned from supabase');
          await handleSessionUser(data.user);
          showAlert("‚úÖ Login successful!");
        }catch(err){ console.error(err); showAlert("‚ùå Login failed: "+(err.message||err)); }
      }

      async function handleSessionUser(user){
        try{
          const { data: userData } = await supabase.from("users").select("role, full_name").eq("id", user.id).maybeSingle();
          currentUser = user;
          currentRole = (userData && userData.role) ? userData.role : "student";
          await enterApp();
        }catch(err){ console.error(err); showAlert("‚ùå Error loading user data"); }
      }

      async function logout(){
        try { await supabase.auth.signOut(); } catch(e){ console.warn('signOut error', e); }
        currentUser=null; currentRole=null; loginEmail.value=""; loginPassword.value="";
        appContainer.style.display="none"; loginScreen.style.display="flex";
        document.body.classList.remove("theme-main"); document.body.classList.add("theme-login");
      }

      async function enterApp(){
        document.body.classList.remove("theme-login"); document.body.classList.add("theme-main");
        loginScreen.style.display="none"; appContainer.style.display="block"; appContainer.removeAttribute('aria-hidden');
        roleLabel.textContent = `Logged in as ${currentRole.charAt(0).toUpperCase()+currentRole.slice(1)}`;
        await loadStudents(); await loadFaculty(); await loadLectures(); await loadAttendanceRecords();
        populateLectures(); populateFacultySelects(); updateTimeFromLecture(); userTypeSel.value="student"; setUserListForType(); applyRolePermissions(); updateSummary(); renderAllCharts(); renderHeatmap();
      }

      function applyRolePermissions(){
        const canEdit = currentRole==="admin"||currentRole==="faculty";
        const canDelete = currentRole==="admin";
        submitBtn.disabled = !canEdit; selectAllBtn.disabled = !canEdit; clearAllBtn.disabled = !canEdit; clearAllRecordsBtn.disabled = !canDelete;
        
        const userListPanel = document.getElementById('userListPanel');
        const lecturePanel = document.getElementById('lecturePanel');
        if(currentRole === "student"){
          userListPanel.style.display = "none";
          lecturePanel.style.display = "none";
        } else {
          userListPanel.style.display = "";
          lecturePanel.style.display = "";
        }
        renderList(); renderRecords();
      }

      async function loadStudents(){ try{ const { data, error } = await supabase.from("students").select("*").order("roll_no",{ascending:true}); if(error) throw error; students = (data||[]).map(s=>({roll:s.roll_no,name:s.name,id:s.id})); }catch(err){ console.error(err); showAlert("‚ùå Error loading students"); } }
      async function loadFaculty(){ try{ const { data, error } = await supabase.from("faculty").select("*").order("roll_no",{ascending:true}); if(error) throw error; faculty = (data||[]).map(f=>({roll:f.roll_no,name:f.name,id:f.id})); }catch(err){ console.error(err); showAlert("‚ùå Error loading faculty"); } }
      async function loadLectures(){ try{ const { data, error } = await supabase.from("lectures").select("*").order("name",{ascending:true}); if(error) throw error; lectures = data || []; }catch(err){ console.error(err); showAlert("‚ùå Error loading lectures"); } }
      async function loadAttendanceRecords(){ try{
          const { data, error } = await supabase.from("attendance_records").select(`*, attendance_details (student_roll, student_name, status)`).order("date",{ascending:false}).order("created_at",{ascending:false});
          if(error) throw error;
          records = (data||[]).map(r=>({
            id: r.id,
            date: r.date,
            day: r.day,
            timeSlot: r.time_slot,
            startTime: r.start_time,
            endTime: r.end_time,
            lecture: r.lecture_name,
            lectureType: r.lecture_type,
            faculty: r.faculty_name,
            proxy: r.is_proxy,
            original: r.original_faculty_name,
            presentCount: r.present_count,
            total: r.total_count,
            attendees: (r.attendance_details||[]).map(d=>({roll:d.student_roll,name:d.student_name,status:d.status}))
          }));
          renderRecords();
        }catch(err){ console.error(err); showAlert("‚ùå Error loading attendance records"); } }

      function setUserListForType(){ 
        const type = userTypeSel.value; 
        currentList = (type==="student"?students:faculty).map(x=>({...x})); 
        attendanceState={}; 
        currentList.forEach(p=>attendanceState[String(p.roll)]={present:false}); 
        renderList(); 
      }
      function onUserTypeChange(){ setUserListForType(); }

      function renderList(){
        const q = searchBox.value.trim().toLowerCase(); 
        let list = currentList.slice(); 
        const mode = sortSelect.value;
        const canEdit = currentRole==="admin" || currentRole==="faculty";

        if(mode==="roll-asc") list.sort((a,b)=>a.roll-b.roll);
        if(mode==="roll-desc") list.sort((a,b)=>b.roll-a.roll);
        if(mode==="name-asc") list.sort((a,b)=>a.name.localeCompare(b.name));

        if(mode==="present") list = list.filter(x=>attendanceState[String(x.roll)] && attendanceState[String(x.roll)].present);
        if(mode==="absent") list = list.filter(x=>!attendanceState[String(x.roll)] || !attendanceState[String(x.roll)].present);
        
        if(q) list = list.filter(x=>String(x.roll).includes(q) || x.name.toLowerCase().includes(q));
        
        usersTableBody.innerHTML = "";
        list.forEach(item=>{
          const tr = document.createElement("tr");
          const tdR = document.createElement("td"); tdR.textContent = item.roll;
          const tdN = document.createElement("td"); tdN.textContent = item.name;
          const tdC = document.createElement("td");
          
          const chk = document.createElement("input"); 
          chk.type="checkbox"; 
          const rollKey = String(item.roll);
          chk.checked = !!(attendanceState[rollKey] && attendanceState[rollKey].present); 
          chk.disabled = !canEdit;
          chk.addEventListener("change", e=>{ 
            if(attendanceState[rollKey]) {
                attendanceState[rollKey].present = e.target.checked; 
            }
            updateSummary(); 
          });
          
          tdC.appendChild(chk);
          tr.appendChild(tdR); tr.appendChild(tdN); tr.appendChild(tdC);
          usersTableBody.appendChild(tr);
        });
        updateSummary();
      }

      function setAll(val){ 
        const canEdit = currentRole==="admin"||currentRole==="faculty"; 
        if(!canEdit) return; 
        currentList.forEach(x=>{
            if(attendanceState[String(x.roll)]) {
                attendanceState[String(x.roll)].present = val;
            }
        }); 
        renderList(); 
      }

      function populateLectures(){ lectureSelect.innerHTML = ""; lectures.forEach(l=>{ const opt=document.createElement("option"); opt.value=l.name; opt.textContent=l.name; lectureSelect.appendChild(opt); }); }
      function updateTimeFromLecture(){ const lecName = lectureSelect.value; const lec = lectures.find(l=>l.name===lecName); if(lec && lec.default_start_time && lec.default_end_time){ startTimeInput.value = lec.default_start_time; endTimeInput.value = lec.default_end_time; } else { startTimeInput.value=""; endTimeInput.value=""; } }
      function populateFacultySelects(){ const fill = el=>{ el.innerHTML=""; faculty.forEach(f=>{ const opt=document.createElement("option"); opt.value=f.name; opt.textContent=`${f.name} (${f.roll})`; el.appendChild(opt); }); }; fill(facultySelect); fill(originalFaculty); }

      async function submitAttendance(){
        const canEdit = currentRole==="admin"||currentRole==="faculty"; if(!canEdit){ showAlert("Only Admin and Faculty can submit attendance"); return; }
        
        submitBtn.disabled = true;
        submitBtn.textContent = "Saving...";
        
        const date = attendanceDate.value || new Date().toISOString().slice(0,10);
        const lecture = lectureSelect.value; const lectureType = lectureTypeSelect.value || "Regular"; const day = daySelect.value || "";
        const facultyName = facultySelect.value; const proxy = isProxy.checked; const original = originalFaculty.value || "";
        const startTime = startTimeInput.value || ""; const endTime = endTimeInput.value || ""; const timeSlot = startTime && endTime ? `${startTime} to ${endTime}` : "";
        
        // Use Strict String Roll Key
        const attendees = currentList.map(p=>{
            const rollKey = String(p.roll);
            const isPresent = attendanceState[rollKey] && attendanceState[rollKey].present;
            return { roll: p.roll, name: p.name, status: isPresent ? "P" : "A" };
        });
        
        const presentCount = attendees.filter(a=>a.status==="P").length;

        try {
          let recordId = currentEditRecordId;
          if(isEditing && currentEditRecordId){
            const { error:updateError } = await supabase.from("attendance_records").update({
              date, day, time_slot: timeSlot, start_time: startTime, end_time: endTime, lecture_name: lecture, lecture_type: lectureType, faculty_name: facultyName, is_proxy: proxy, original_faculty_name: original, present_count: presentCount, total_count: attendees.length
            }).eq("id", currentEditRecordId);
            if(updateError) throw updateError;
            const { error: delErr } = await supabase.from("attendance_details").delete().eq("attendance_record_id", currentEditRecordId);
            if(delErr) throw delErr;
          } else {
            const { data:newRecord, error:insertError } = await supabase.from("attendance_records").insert({
              date, day, time_slot: timeSlot, start_time: startTime, end_time: endTime, lecture_name: lecture, lecture_type: lectureType, faculty_name: facultyName, is_proxy: proxy, original_faculty_name: original, present_count: presentCount, total_count: attendees.length, created_by: currentUser ? currentUser.id : null
            }).select().single();
            if(insertError) throw insertError;
            recordId = newRecord.id;
          }

          const detailsToInsert = attendees.map(a=>({ attendance_record_id: recordId, student_roll: a.roll, student_name: a.name, status: a.status }));
          const { error:detailsError } = await supabase.from("attendance_details").insert(detailsToInsert);
          if(detailsError) throw detailsError;

          showAlert("‚úÖ Attendance saved successfully!");
          await loadAttendanceRecords();
          exitEditMode(true);
          updateSummary(); renderAllCharts(); renderHeatmap();
        } catch(err){ 
            console.error(err); 
            showAlert("‚ùå Error saving attendance: "+(err.message||err)); 
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = isEditing ? "Update Attendance" : "Submit Attendance";
        }
      }

      function enterEditMode(recordId, record){
        attendanceState = {};

        isEditing = true; currentEditRecordId = recordId; submitBtn.textContent = "Update Attendance"; cancelEditBtn.style.display = "inline-flex";
        attendanceDate.value = record.date; lectureSelect.value = record.lecture; lectureTypeSelect.value = record.lectureType || "Regular"; daySelect.value = record.day || "Monday"; facultySelect.value = record.faculty || (faculty[0] && faculty[0].name);
        isProxy.checked = !!record.proxy; proxyDetails.style.display = isProxy.checked ? "block" : "none"; originalFaculty.value = record.original || facultySelect.value;
        let st = record.startTime || ""; let en = record.endTime || "";
        if((!st || !en) && record.timeSlot){ const parts = record.timeSlot.split(" to "); st = parts[0]||""; en = parts[1]||""; }
        startTimeInput.value = st; endTimeInput.value = en;
        userTypeSel.value = "student"; 
        
        const type = userTypeSel.value; 
        currentList = (type==="student"?students:faculty).map(x=>({...x})); 
        
        // Strict String comparison to load existing state
        currentList.forEach(p=>{ 
            const rollKey = String(p.roll);
            const found = (record.attendees||[]).find(a=>String(a.roll) === rollKey); 
            attendanceState[rollKey] = { present: found ? found.status==="P" : false }; 
        });
        
        renderList();
      }

      function exitEditMode(silent){
        isEditing = false; currentEditRecordId = null; submitBtn.textContent = "Submit Attendance"; cancelEditBtn.style.display = "none"; setUserListForType(); if(!silent) showAlert("Edit cancelled");
      }

      function renderRecords(){
        recordsTableBody.innerHTML = "";
        const canEdit = currentRole==="admin"||currentRole==="faculty";
        const canDelete = currentRole==="admin";

        records.forEach((r)=>{
          const tr = document.createElement("tr");
          // Replaced Present button with just View button that triggers new panel
          const viewBtn = `<button class="record-action view" type="button" aria-label="View Details">View</button>`;
          
          const editHtml = canEdit ? `<button class="record-action edit" type="button" aria-label="Edit record">Edit</button>` : `<span style="display:inline-block;padding:6px 8px;border-radius:8px;color:#9ca3af">-</span>`;
          const deleteHtml = canDelete ? `<button class="record-action delete" type="button" aria-label="Delete record">Delete</button>` : "";

          const badgeHtml = `<span class="record-badge" aria-hidden="true">${r.presentCount || 0}/${r.total || 0}</span>`;

          tr.innerHTML =
            `<td>${escapeHtml(r.date)}</td>
             <td>${escapeHtml(r.timeSlot || "")}</td>
             <td>${escapeHtml(r.lecture)}</td>
             <td>${escapeHtml(r.faculty)}</td>
             <td>${badgeHtml}</td>
             <td class="actions">${viewBtn}</td>
             <td style="${canEdit ? "" : "display:none;"}">${editHtml}</td>
             <td style="${canDelete ? "" : "display:none;"}">${deleteHtml}</td>`;

          recordsTableBody.appendChild(tr);

          const tdView = tr.querySelectorAll("td")[5];
          const vBtn = tdView.querySelector(".record-action.view");
          if(vBtn) vBtn.addEventListener("click", ()=>viewRecordDetails(r));

          if(canEdit){
            const editBtn = tr.querySelector(".record-action.edit");
            if(editBtn) editBtn.addEventListener("click", ()=>enterEditMode(r.id, r));
          }
          if(canDelete){
            const delBtn = tr.querySelector(".record-action.delete");
            if(delBtn) delBtn.addEventListener("click", ()=>deleteSingleRecord(r.id));
          }
        });
      }

      async function deleteSingleRecord(recordId){
        if(currentRole!=="admin") { showAlert("Only Admin can delete records"); return; }
        if(!confirm("Delete this record?")) return;
        try{
          const { error } = await supabase.from("attendance_records").delete().eq("id", recordId);
          if(error) throw error;
          showAlert("‚úÖ Record deleted");
          await loadAttendanceRecords(); renderAllCharts(); renderHeatmap();
        }catch(err){ console.error(err); showAlert("‚ùå Error deleting record"); }
      }

      // NEW FUNCTION TO SHOW DETAILS IN THE NEW PANEL
      function viewRecordDetails(record){
          detailsViewTitle.textContent = `${record.lecture} (${record.date})`;
          detailsViewBody.innerHTML = "";
          
          // Safety sort: P first, deduplicate
          let uniqueAttendees = [];
          const seen = new Set();
          const sorted = (record.attendees||[]).slice().sort((a,b) => (a.status==='P' ? -1 : 1));
          
          sorted.forEach(a=>{
             const k = String(a.roll);
             if(!seen.has(k)){ seen.add(k); uniqueAttendees.push(a); }
          });
          
          // Sort by Roll for display
          uniqueAttendees.sort((a,b)=> a.roll - b.roll);

          uniqueAttendees.forEach(a=>{
              const tr = document.createElement('tr');
              const badgeClass = a.status==='P' ? 'status-badge p' : 'status-badge a';
              const statusText = a.status==='P' ? 'Present' : 'Absent';
              tr.innerHTML = `
                <td>${a.roll}</td>
                <td>${a.name}</td>
                <td style="text-align:right"><span class="${badgeClass}">${statusText}</span></td>
              `;
              detailsViewBody.appendChild(tr);
          });
          
          detailsViewPanel.style.display = 'block';
          // scroll to panel
          detailsViewPanel.scrollIntoView({ behavior: 'smooth' });
      }

      function closeAttendanceModal(){ const b = document.getElementById('attModalBackdrop'); b.style.display='none'; b.setAttribute('aria-hidden','true'); }

      async function clearAllRecords(){
        if(currentRole!=="admin"){ showAlert("Only Admin can delete all records"); return; }
        if(!confirm("Delete ALL attendance records? This cannot be undone.")) return;
        try{
          const { error } = await supabase.from("attendance_records").delete().neq("id", null);
          if(error) throw error;
          showAlert("‚úÖ All records deleted");
          await loadAttendanceRecords(); renderAllCharts(); renderHeatmap();
        }catch(err){ console.error(err); showAlert("‚ùå Error deleting records"); }
      }

      function updateSummary(){
        const date = attendanceDate.value || new Date().toISOString().slice(0,10);
        const presentSet = new Set();
        records.filter(r=>r.date===date).forEach(r=>{
          (r.attendees||[]).forEach(a=>{
            if(a.status === "P") presentSet.add(a.roll);
          });
        });
        const present = presentSet.size;
        const totalStudents = students.length || 0;
        const absent = Math.max(0, totalStudents - present);
        const todays = records.filter(r=>r.date===date);

        presentCountEl.textContent = present;
        absentCountEl.textContent = absent;
        lecturesTodayEl.textContent = todays.length;
        kpiLecturesToday.textContent = todays.length;
      }

      function renderAllCharts(){
        renderStudentsPie();
        renderFacultySummary();
        renderTimeline();
        renderOverviewAndTrend();
        renderDailyPercent();
      }

      function renderDailyPercent(){
        heatbarList.innerHTML = "";
        const dateList = {};
        records.forEach(r=>{
          if(!dateList[r.date]) dateList[r.date] = {present:0,total:0};
          dateList[r.date].present += r.presentCount||0;
          dateList[r.date].total += r.total||0;
        });
        const dates = Object.keys(dateList).sort().slice(-10);
        dates.forEach(d=>{
          const info=dateList[d]; const pct = info.total?(info.present/info.total)*100:0;
          const row=document.createElement("div");
          row.style.display="flex"; row.style.alignItems="center"; row.style.gap="8px"; row.style.marginBottom="6px";
          row.innerHTML = `
            <div style="width:70px;font-size:13px">${d}</div>
            <div class="bar" style="flex:1"><div class="bar-fill" style="width:${pct}%"></div></div>
            <div style="width:40px;font-size:13px;text-align:right">${pct.toFixed(0)}%</div>
          `;
          heatbarList.appendChild(row);
        });
      }

      function renderStudentsPie(){
        const date = attendanceDate.value || new Date().toISOString().slice(0,10);
        const todays = records.filter(r=>r.date===date);
        const presentRolls = new Set();
        todays.forEach(r=>{ (r.attendees||[]).forEach(a=>{ if(a.status==='P') presentRolls.add(a.roll); }); });
        const totalStudents = students.length;
        const present = presentRolls.size;
        const absent = Math.max(0, totalStudents - present);
        const pct = totalStudents ? ((present/totalStudents)*100).toFixed(1) : "0.0";
        studentsStatsText.textContent = `Date: ${date} ‚Ä¢ Present: ${pct}%`;

        const ctx = document.getElementById("studentsPie").getContext("2d");
        if (studentsPieChart) studentsPieChart.destroy();
        studentsPieChart = new Chart(ctx, { type:'pie', data:{ labels:['Present','Absent'], datasets:[{ data:[present,absent] }] }, options:{ plugins:{ legend:{display:true,position:'bottom'}, tooltip:{ callbacks:{ label:function(ctx){ const dataArr = ctx.dataset.data; const total = dataArr.reduce((a,b)=>a+b,0)||1; const value = ctx.parsed; const p = ((value/total)*100).toFixed(1); return `${p}%`; } } } } } });
      }

      function renderFacultySummary(){
        if(!facultySummaryBody) return;
        const summary = {};
        faculty.forEach(f => summary[f.name] = { name: f.name, total: 0, regular: 0, proxy: 0 });

        records.forEach(r => {
          const facName = r.faculty || '';
          if(!facName) return;
          if(!summary[facName]) summary[facName] = { name: facName, total:0, regular:0, proxy:0 };
          summary[facName].total++;
          if(r.proxy) summary[facName].proxy++; else summary[facName].regular++;
        });

        const rows = Object.values(summary).sort((a,b)=> b.total - a.total);
        let html = '';
        rows.forEach(r => {
          html += `<tr>
            <td style="padding:8px 6px">${escapeHtml(r.name)}</td>
            <td style="padding:8px 6px;text-align:right">${r.total}</td>
            <td style="padding:8px 6px;text-align:right">${r.regular}</td>
            <td style="padding:8px 6px;text-align:right">${r.proxy}</td>
          </tr>`;
        });
        facultySummaryBody.innerHTML = html || `<tr><td colspan="4" style="padding:12px;color:#6b7280">No data available</td></tr>`;
      }

      function renderHeatmap(){
        if(!heatmapEl) return;
        heatmapEl.innerHTML = "";
        const days = 30;
        const now = new Date(attendanceDate.value || new Date().toISOString().slice(0,10));
        const base = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const dailyPct = [];
        for(let i=days-1;i>=0;i--){
          const d = new Date(base);
          d.setDate(base.getDate() - i);
          const iso = d.toISOString().slice(0,10);
          let presentSet = new Set(), totalPossible = students.length || 0;
          records.filter(r=>r.date===iso).forEach(r=>{ (r.attendees||[]).forEach(a=>{ if(a.status==='P') presentSet.add(a.roll); }); });
          const present = presentSet.size;
          const pct = totalPossible ? Math.round((present/totalPossible)*100) : 0;
          dailyPct.push({ date: iso, pct, present });
        }
        const colorFor = pct=>{
          if(pct>=90) return "#065f46";
          if(pct>=75) return "#10b981";
          if(pct>=50) return "#84cc16";
          if(pct>=25) return "#f59e0b";
          if(pct>0) return "#f97316";
          return "#e5e7eb";
        };
        dailyPct.forEach(d=>{
          const div = document.createElement("div");
          div.className = "heatday";
          div.style.background = colorFor(d.pct);
          div.title = `${d.date}\nPresent: ${d.present} ‚Ä¢ ${d.pct}%`;
          div.textContent = d.date.slice(5).replace("-","/");
          heatmapEl.appendChild(div);
        });
      }

      function renderTimeline(){
        if(!timelineEl) return;
        timelineEl.innerHTML = "";
        const date = attendanceDate.value || new Date().toISOString().slice(0,10);
        const daysRecords = records.filter(r=>r.date===date).sort((a,b)=> (a.startTime||"") > (b.startTime||"") ? 1 : -1 );
        if(!daysRecords.length){ timelineEl.innerHTML = `<div class="att-modal-empty">No sessions for ${date}</div>`; return; }
        daysRecords.forEach(r=>{
          const item = document.createElement("div");
          item.className = "timeline-item";
          const label = document.createElement("div");
          label.style.width = "160px";
          label.innerHTML = `<strong>${r.timeSlot || r.startTime || ""}</strong><div style="font-size:12px;color:#6b7280">${r.lecture} ‚Ä¢ ${r.faculty}</div>`;
          const stats = document.createElement("div");
          stats.style.flex = "1";
          const pct = r.total ? Math.round((r.presentCount / r.total) * 100) : 0;
          stats.innerHTML = `<div class="bar"><div class="bar-fill" style="width:${pct}%;background:${pct>66?'#10b981':'#f59e0b'}"></div></div>`;
          const meta = document.createElement("div");
          meta.style.minWidth = "70px";
          meta.style.textAlign = "right";
          meta.innerHTML = `<div style="font-weight:600">${r.presentCount}/${r.total}</div><div style="font-size:12px;color:#6b7280">${pct}%</div>`;
          item.appendChild(label); item.appendChild(stats); item.appendChild(meta);
          timelineEl.appendChild(item);
        });
      }

      function renderOverviewAndTrend(){
        renderOverviewKPIs();
        renderAttendanceTrend();
        renderRecentAlerts();
      }

      function renderOverviewKPIs(){
        const today = new Date(attendanceDate.value || new Date().toISOString().slice(0,10));
        const formatDate = d => d.toISOString().slice(0,10);

        let sumPct = 0, countDays = 0;
        for(let i=6;i>=0;i--){
          const d = new Date(today); d.setDate(today.getDate() - i);
          const iso = formatDate(d);
          const stats = computeDayPercent(iso);
          if(stats.total>0){ sumPct += stats.pct; countDays++; }
        }
        const avg7 = countDays ? (sumPct / countDays) : 0;
        kpiAvg7d.textContent = `${avg7 ? avg7.toFixed(1) : '0.0'}%`;

        let best = { date: null, pct: -1 };
        for(let i=29;i>=0;i--){
          const d = new Date(today); d.setDate(today.getDate() - i);
          const iso = formatDate(d);
          const stats = computeDayPercent(iso);
          if(stats.total>0 && stats.pct > best.pct){ best = { date: iso, pct: stats.pct }; }
        }
        kpiBestDay.textContent = best.date ? `${best.date} ‚Ä¢ ${best.pct}%` : 'N/A';
      }

      function computeDayPercent(isoDate){
        let presentSet = new Set(), totalPossible = students.length || 0;
        records.filter(r=>r.date===isoDate).forEach(r=>{ (r.attendees||[]).forEach(a=>{ if(a.status==='P') presentSet.add(a.roll); }); });
        const present = presentSet.size;
        const pct = totalPossible ? Math.round((present/totalPossible)*100) : 0;
        return { total: totalPossible, present, pct };
      }

      function renderAttendanceTrend(){
        const ctx = trendCanvas.getContext('2d');
        const today = new Date(attendanceDate.value || new Date().toISOString().slice(0,10));
        const formatDate = d => d.toISOString().slice(0,10);
        const labels = [], data = [];
        for(let i=6;i>=0;i--){
          const d = new Date(today); d.setDate(today.getDate() - i);
          const iso = formatDate(d);
          labels.push(iso.slice(5)); // MM-DD
          const stats = computeDayPercent(iso);
          data.push(stats.pct || 0);
        }
        if(trendChart) trendChart.destroy();
        trendChart = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [{ label:'Attendance %', data, fill:true, tension:0.35, pointRadius:4 }] },
          options: {
            plugins:{ legend:{display:false} },
            scales:{ y:{ beginAtZero:true, max:100 } },
            elements:{ line:{ borderWidth:2 } }
          }
        });
      }

      function renderRecentAlerts(){
        if(!alertsList) return;
        alertsList.innerHTML = "";
        const alerts = [];
        const threshold = 30;
        const today = new Date(attendanceDate.value || new Date().toISOString().slice(0,10));
        const formatDate = d => d.toISOString().slice(0,10);
        for(let i=0;i<7;i++){
          const d = new Date(today); d.setDate(today.getDate() - i);
          const iso = formatDate(d);
          records.filter(r=>r.date===iso).forEach(r=>{
            const pct = r.total ? Math.round((r.presentCount / r.total) * 100) : 0;
            if(pct < threshold){
              alerts.push({ date: iso, lecture: r.lecture, faculty: r.faculty, pct, type: 'low' });
            } else {
              alerts.push({ date: iso, lecture: r.lecture, faculty: r.faculty, pct, type: 'info' });
            }
          });
        }
        alerts.sort((a,b)=> {
          if(a.type !== b.type) return a.type==='low' ? -1 : 1;
          return b.date.localeCompare(a.date);
        });
        const shown = alerts.slice(0,8);
        if(!shown.length) alertsList.innerHTML = `<li class="att-modal-empty">No alerts in the last 7 days</li>`;
        else {
          shown.forEach(al=>{
            const li = document.createElement('li');
            const severity = al.type==='low' ? `<span class="alerts-severity-low">${al.pct}%</span>` : `<strong>${al.pct}%</strong>`;
            li.innerHTML = `<div style="display:flex;justify-content:space-between;gap:8px"><div><div style="font-weight:700">${escapeHtml(al.lecture)}</div><div style="font-size:12px;color:#6b7280">${al.date} ‚Ä¢ ${escapeHtml(al.faculty)}</div></div><div style="text-align:right">${severity}</div></div>`;
            alertsList.appendChild(li);
          });
        }
      }

      function renderDailyStatus(){
        const tbody = dailyStatusBody;
        if(!tbody) return;
        const today = attendanceDate.value || new Date().toISOString().slice(0,10);
        const presentSet = new Set();
        
        records.filter(r=>r.date===today).forEach(r=>{
          (r.attendees||[]).forEach(a=>{
            if(a.status==='P') presentSet.add(a.roll);
          });
        });
        
        const rows = [];
        students.forEach(s=>{
          if(presentSet.has(s.roll)) rows.push({roll:s.roll,name:s.name,status:"Present"});
        });
        students.forEach(s=>{
          if(!presentSet.has(s.roll)) rows.push({roll:s.roll,name:s.name,status:"Absent"});
        });
        tbody.innerHTML = rows.map(r=>`
          <tr>
            <td>${r.roll}</td>
            <td>${r.name}</td>
            <td style="text-align:right;font-weight:600;color:${r.status==='Present'?'#059669':'#dc2626'}">${r.status}</td>
          </tr>
        `).join("");
      }

      async function handleScan(code){
        if(!code) return;
        const student = students.find(s=>String(s.roll) === String(code));
        if(!student){ showAlert("No student found for scanned code: "+code); return; }
        
        const rollKey = String(student.roll);
        if(attendanceState[rollKey]) {
            attendanceState[rollKey].present = true;
        } else {
            attendanceState[rollKey] = { present:true };
        }
        
        addScanLogEntry(student.roll, student.name); 
        renderList();
        try{ await supabase.from("scan_log").insert({ student_roll: student.roll, student_name: student.name, lecture_name: lectureSelect.value, scanned_by: currentUser ? currentUser.id : null }); }catch(err){ console.error("Error saving scan log:",err); }
      }

      function addScanLogEntry(roll,name){ const now=new Date(); const timeStr=now.toLocaleTimeString(undefined,{hour:"2-digit",minute:"2-digit"}); const lecture = lectureSelect.value; scanLog.unshift({time:timeStr,roll,name,lecture}); if(scanLog.length>50) scanLog.pop(); renderScanLog(); }
      function renderScanLog(){ if(!scanLogTbody) return; scanLogTbody.innerHTML=""; scanLog.forEach(entry=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${entry.time}</td><td>${entry.roll}</td><td>${entry.name}</td><td>${entry.lecture}</td>`; scanLogTbody.appendChild(tr); }); }

      function downloadCSV(){ const rows=[["Date","Day","Time","Lecture","LectureType","Faculty","Proxy","OriginalFaculty","Roll","Name","Status"]]; records.forEach(r=>{ r.attendees.forEach(a=>{ rows.push([r.date, r.day||"", r.timeSlot||"", r.lecture, r.lectureType||"", r.faculty||"", r.proxy ? "Yes":"No", r.original||"", a.roll, a.name, a.status]); }); }); const csv = rows.map(row=>row.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n"); const blob = new Blob([csv],{type:"text/csv;charset=utf-8;"}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download="attendance_records.csv"; a.click(); URL.revokeObjectURL(url); }

      function showAlert(msg){ const div=document.createElement('div'); div.className='alert'; div.textContent = msg; appContainer.insertBefore(div,appContainer.firstChild); setTimeout(()=>div.remove(),4000); }

      function escapeHtml(str){
        if(str === null || str === undefined) return "";
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function refreshEverything(){
        updateSummary();
        renderDailyStatus();
        renderAllCharts();
        renderHeatmap();
        renderAlerts();
        renderTimeline();
        renderFacultySummary();
      }

      init();
    })();
  </script>
</body>
</html>
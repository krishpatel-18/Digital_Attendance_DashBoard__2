<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TYBCA Attendance Dashboard - Supabase</title>
  <style>
    /* (styles identical to prior file ‚Äî omitted here for brevity in this message)
       In your file, include the same CSS as before. For brevity in this chat I'll
       include the same CSS block you had previously. */
    :root{--panel:#ffffff;--accent:#0f9d58;--muted:#6b7280;}
    .theme-login{--bg:radial-gradient(circle at top left,#7b2ff7,#5a2fd6,#5826c4,#7520b7,#9121b4,#b623b5,#d72ab8);}
    .theme-main{--bg:radial-gradient(circle at top left,#7b2ff7,#5a2fd6,#5826c4,#7520b7,#9121b4,#b623b5,#d72ab8);--accent:#0077ff;}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:var(--bg);color:#111827;min-height:100vh;padding:16px;transition:background 0.4s ease;}
    .login-wrapper{min-height:100vh;display:flex;align-items:center;justify-content:center;}
    .login-card{width:100%;max-width:420px;background:#ffffff;border-radius:24px;box-shadow:0 18px 45px rgba(15,23,42,0.25);padding:24px 22px 20px;}
    .login-header{text-align:center;margin-bottom:16px}
    .login-header h1{font-size:22px;margin-top:6px;margin-bottom:4px}
    .login-header p{font-size:14px;color:var(--muted)}
    .login-label{font-size:14px;font-weight:600;margin-bottom:4px;color:#111827;display:block}
    .login-input,.login-select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb;font-size:14px;margin-bottom:10px}
    .login-input:focus,.login-select:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 1px rgba(59,130,246,0.4)}
    .login-btn{width:100%;margin-top:4px;padding:11px 12px;border-radius:999px;border:none;cursor:pointer;font-weight:600;font-size:15px;background:linear-gradient(135deg,#00c853,#009688);color:#fff;display:flex;align-items:center;justify-content:center;gap:8px}
    .info-box{margin-top:12px;padding:8px 10px;border-radius:12px;font-size:12px;background:#e0f2fe;border-left:4px solid #2563eb}
    .app-container{max-width:1200px;margin:0 auto;display:none}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;margin-top:4px}
    header h2{font-size:18px;color:#f9fafb;text-shadow:0 1px 3px rgba(15,23,42,0.8)}
    .top-right{display:flex;flex-direction:column;align-items:flex-end;gap:4px}
    .top-controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .top-controls input,.top-controls select{padding:7px 8px;border-radius:8px;border:1px solid #e5e7eb;font-size:13px;background:#fff}
    main{display:flex;gap:12px}
    .left{flex:2;display:flex;flex-direction:column;gap:12px}
    .right{flex:1;display:flex;flex-direction:column;gap:12px}
    .panel{background:rgba(255,255,255,0.96);border-radius:12px;padding:12px;box-shadow:0 4px 12px rgba(15,23,42,0.25);backdrop-filter:blur(8px)}
    h3.panel-title{margin-bottom:6px;font-size:15px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:6px 8px;border-bottom:1px solid #e5e7eb;text-align:left}
    thead th{background:#f9fafb;position:sticky;top:0;z-index:1}
    #usersTableWrap{max-height:260px;overflow:auto;margin-top:6px}
    #recordsWrap{max-height:260px;overflow:auto;margin-top:6px}
    #studentsReportWrap{max-height:220px;overflow:auto;margin-top:6px}
    #scanLogWrap{max-height:160px;overflow:auto;margin-top:6px}
    #facultySummaryWrap{max-height:200px;overflow:auto;margin-top:6px}
    .form-row{display:flex;align-items:center;gap:8px;margin:7px 0;font-size:13px}
    .form-row label{min-width:80px;color:#4b5563}
    input[type="text"],select,input[type="time"],input[type="email"],input[type="password"]{padding:6px 8px;border-radius:8px;border:1px solid #e5e7eb;font-size:13px}
    button{background:var(--accent);color:#fff;padding:7px 10px;border-radius:8px;border:none;cursor:pointer;font-size:13px;display:inline-flex;align-items:center;gap:5px}
    button.secondary{background:#fff;color:#111827;border:1px solid #e5e7eb}
    button.download-btn-primary{background:#16a34a}
    button:disabled{opacity:0.55;cursor:not-allowed}
    .controls-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px}
    .summary p{font-size:13px;margin:2px 0}
    .stats-line{font-size:12px;color:#4b5563;margin:2px 0 4px}
    footer{text-align:center;margin-top:12px;font-size:11px;color:#e5e7eb}
    .alert{padding:9px 10px;margin-top:8px;background:#e6fffa;border-radius:10px;color:#065f46;font-size:13px;box-shadow:0 2px 6px rgba(16,185,129,0.25)}
    @media(max-width:900px){main{flex-direction:column}header{flex-direction:column;align-items:flex-start;gap:6px} .top-right{align-items:flex-start} .top-controls{justify-content:flex-start} #usersTableWrap{max-height:260px}}

    /* Modal + UX improvements kept the same as before */
    .att-modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:1100}
    .att-modal{width:calc(100% - 40px);max-width:760px;background:#fff;border-radius:12px;padding:16px;box-shadow:0 10px 30px rgba(2,6,23,0.35);max-height:80vh;overflow:auto}
    .att-modal-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px}
    .att-modal-title{font-size:16px;font-weight:700;color:#111827}
    .att-modal-sub{font-size:13px;color:#6b7280}
    .att-modal-close{background:#ef4444;color:#fff;padding:6px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .att-modal-list{margin-top:8px}
    .att-modal-list table{width:100%;border-collapse:collapse}
    .att-modal-list th,.att-modal-list td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:left;font-size:14px}
    .att-modal-empty{padding:18px;text-align:center;color:#6b7280}
    .record-action { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; color:#111827; font-size:13px; cursor:pointer; box-shadow:0 1px 0 rgba(0,0,0,0.03); }
    .record-action.present { background:#ecfdf5; color:#065f46; border-color:#10b981; }
    .record-action.absent { background:#fff7ed; color:#7c2d12; border-color:#f97316; }
    .record-action.edit { background:#eef2ff; color:#3730a3; border-color:#a78bfa; }
    .record-action.delete { background:#fff1f2; color:#991b1b; border-color:#fca5a5; }

    .record-badge { display:inline-block; min-width:40px; padding:6px 10px; border-radius:999px; text-align:center; font-weight:700; background:linear-gradient(90deg,#f8fafc,#fff); color:#111827; border:1px solid #e6eef8; font-size:13px; }
    #recordsTable td .actions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    #leaderboardTable thead th { font-weight:700; background:#fafafa; font-size:13px; }
    #leaderboardTable tbody td { padding:8px 6px; border-bottom:1px solid #f3f4f6; font-size:13px; color:#111827; }
    .leader-percent { font-weight:700; }
    .leader-low { color:#b91c1c; } .leader-mid { color:#f59e0b; } .leader-high { color:#065f46; }
    #reportsVisualizer{display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px}
    .heatmap-grid{display:grid;grid-template-columns: repeat(7, 1fr); gap:6px; padding:8px}
    .heatday{height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:11px;color:#0b1220;background:#e5e7eb}
    .heat-legend{display:flex;gap:6px;align-items:center;margin-top:6px;font-size:12px;flex-wrap:wrap}
    #adminPanel{display:none;margin-bottom:12px}
    .admin-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .admin-list{margin-top:8px;padding:10px;background:#fff;border-radius:8px}
    .is-hidden-panel{opacity:0.45}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="theme-login">
  <!-- LOGIN -->
  <div id="loginScreen" class="login-wrapper">
    <div class="login-card">
      <div class="login-header">
        <h2 style="text-transform:uppercase;font-size:22px;font-weight:800;margin-bottom:14px;color:#1f2937;letter-spacing:1.2px">DIGITAL ATTENDANCE TY-BCA 2025-26</h2>
        <div style="font-size:40px;margin-top:-4px">üîê</div>
        <h1>Admin / Faculty / Student Login</h1>
        <p>Enter your credentials to access</p>
      </div>

      <label class="login-label" for="loginEmail">Email</label>
      <input id="loginEmail" type="email" class="login-input" placeholder="Enter email" />
      <label class="login-label" for="loginPassword">Password</label>
      <input id="loginPassword" type="password" class="login-input" placeholder="Enter password" />
      <button id="loginSubmit" class="login-btn"><span>üîí</span><span>Login</span></button>

      <div class="info-box">
        <div style="font-weight:600;margin-bottom:3px">Powered by Supabase</div>
        <div>Secure authentication and real-time database</div>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="appContainer" class="app-container">
    <header>
      <h2>TYBCA Attendance Dashboard</h2>
      <div class="top-right">
        <div class="top-controls">
          <input type="date" id="attendanceDate" />
          <select id="userType"><option value="student">Students</option><option value="faculty">Faculty</option></select>
          <input id="searchBox" placeholder="Search name or roll no" />
          <button id="logoutBtn" class="secondary">Logout</button>
        </div>
        <span id="roleLabel" style="font-size:12px;color:#f9fafb;background:rgba(15,23,42,0.35);padding:4px 8px;border-radius:999px"></span>
        <span id="connectionStatus" style="font-size:12px;color:#fff;background:#22c55e;padding:4px 8px;border-radius:999px">Connected to Supabase</span>
      </div>
    </header>

    <!-- ADMIN PANEL (visible only to admin role) -->
    <div id="adminPanel" class="panel" aria-hidden="true">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h3 style="margin:0">Admin Controls</h3>
          <div style="font-size:13px;color:#6b7280">Hide/show panels for students & faculty. Settings persist in Supabase.</div>
        </div>
        <div class="admin-controls">
          <button id="unhideSelected" class="record-action">Unhide selected</button>
          <button id="unhideAll" class="record-action">Unhide all</button>
        </div>
      </div>

      <div class="admin-list" id="adminPanelList" style="margin-top:10px"></div>
    </div>

    <main>
      <section class="left">
        <div class="panel">
          <h3 class="panel-title">User List</h3>
          <div class="controls-row">
            <select id="sortSelect">
              <option value="">Sort / Filter</option><option value="roll-asc">Roll ‚Üë</option><option value="roll-desc">Roll ‚Üì</option><option value="name-asc">Name A‚ÜíZ</option><option value="present">Present</option><option value="absent">Absent</option>
            </select>
            <button id="selectAllBtn">Select All</button>
            <button id="clearAllBtn" class="secondary">Clear</button>
            <input id="scanInput" placeholder="Scan ID / Roll & press Enter" />
          </div>
          <div id="usersTableWrap">
            <table id="usersTable">
              <thead><tr><th>Roll</th><th>Name</th><th>Present</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="panel">
          <h3 class="panel-title">Lecture / Session Details</h3>
          <div class="form-row"><label>Lecture</label><select id="lectureSelect"></select></div>
          <div class="form-row"><label>Type</label><select id="lectureType"><option value="Regular">Regular Lecture</option><option value="ProxyLecture">Proxy Lecture</option></select></div>
          <div class="form-row"><label>Start</label><input type="time" id="startTimeInput" /></div>
          <div class="form-row"><label>End</label><input type="time" id="endTimeInput" /></div>
          <div class="form-row"><label>Day</label><select id="daySelect"><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option>Saturday</option></select></div>
          <div class="form-row"><label>Faculty</label><select id="facultySelect"></select></div>
          <div class="form-row"><label><input type="checkbox" id="isProxy" /> Proxy?</label></div>
          <div id="proxyDetails" style="display:none"><div class="form-row"><label>Original</label><select id="originalFaculty"></select></div></div>
          <div class="form-row"><button id="submitAttendanceBtn">Submit Attendance</button><button id="cancelEditBtn" class="secondary" style="display:none">Cancel Edit</button></div>
        </div>

        <div id="attendanceReportsPanel" class="panel">
          <h3 class="panel-title">Attendance Reports (Visualization) <small style="font-size:12px;color:#6b7280">(can be hidden by admin)</small></h3>
          <div class="controls-row">
            <label style="font-size:13px;color:#6b7280;margin-right:auto">Admin hide: <input type="checkbox" class="admin-hide-checkbox" data-panel="attendanceReportsPanel" style="margin-left:8px"/></label>
            <button id="downloadStudentsReportCsv" class="download-btn-primary">Download Students CSV</button>
            <button id="downloadFacultyReportCsv" class="download-btn-primary">Download Faculty CSV</button>
          </div>

          <div id="regularStudentsWrap" style="margin-top:8px; padding:8px; background:#fff; border-radius:8px;" data-panel="regularStudentsWrap">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <strong>Regular Students (Summary)</strong>
              <label style="font-size:13px;color:#6b7280">Admin hide: <input type="checkbox" class="admin-hide-checkbox" data-panel="regularStudentsWrap" style="margin-left:8px"/></label>
            </div>
            <div style="max-height:220px; overflow:auto; margin-top:8px;">
              <table id="regularStudentsTable" style="width:100%">
                <thead>
                  <tr><th style="text-align:left">Roll</th><th style="text-align:left">Name</th><th style="text-align:right">Present</th><th style="text-align:right">Absent</th><th style="text-align:right">Total</th><th style="text-align:right">%</th></tr>
                </thead>
                <tbody id="regularStudentsBody"></tbody>
              </table>
            </div>
          </div>

          <div id="heatbarWrap" style="margin-top:12px; padding:8px; background:#fff; border-radius:8px;" data-panel="heatbarWrap">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <strong>Daily Percent (recent days)</strong>
              <label style="font-size:13px;color:#6b7280">Admin hide: <input type="checkbox" class="admin-hide-checkbox" data-panel="heatbarWrap" style="margin-left:8px"/></label>
            </div>
            <div id="heatbarList" style="margin-top:8px"></div>
            <div class="heat-legend" style="margin-top:10px">
              <div class="heat-legend-item"><div style="width:16px;height:12px;background:#065f46;border-radius:3px"></div><div>90-100%</div></div>
              <div class="heat-legend-item"><div style="width:16px;height:12px;background:#10b981;border-radius:3px"></div><div>75-89%</div></div>
              <div class="heat-legend-item"><div style="width:16px;height:12px;background:#84cc16;border-radius:3px"></div><div>50-74%</div></div>
              <div class="heat-legend-item"><div style="width:16px;height:12px;background:#f59e0b;border-radius:3px"></div><div>25-49%</div></div>
              <div class="heat-legend-item"><div style="width:16px;height:12px;background:#f97316;border-radius:3px"></div><div>1-24%</div></div>
              <div class="heat-legend-item"><div style="width:16px;height:12px;background:#e5e7eb;border-radius:3px"></div><div>0%</div></div>
            </div>
          </div>

          <div id="monthlyHeatWrap" style="margin-top:12px; padding:8px; background:#fff; border-radius:8px;" data-panel="monthlyHeatWrap">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <strong>Monthly Heatmap (grid) ‚Äî last 30 days</strong>
              <label style="font-size:13px;color:#6b7280">Admin hide: <input type="checkbox" class="admin-hide-checkbox" data-panel="monthlyHeatWrap" style="margin-left:8px"/></label>
            </div>
            <div id="heatmap" class="heatmap-grid" style="margin-top:8px"></div>
          </div>

        </div>
      </section>

      <aside class="right">
        <div class="panel" id="todaySummaryPanel" data-panel="todaySummaryPanel">
          <h3 class="panel-title">Today's Summary</h3>
          <div class="summary"><p>Present today: <span id="presentCount">0</span></p><p>Absent today: <span id="absentCount">0</span></p><p>Lectures today: <span id="lecturesToday">0</span></p></div>
        </div>

        <div class="panel" id="scanLogPanel" data-panel="scanLogPanel">
          <h3 class="panel-title">Scan Log</h3>
          <div id="scanLogWrap">
            <table id="scanLogTable"><thead><tr><th>Time</th><th>Roll</th><th>Name</th><th>Lecture</th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <div class="panel" id="attendanceRecordsPanel" data-panel="attendanceRecordsPanel">
          <h3 class="panel-title">Attendance Records</h3>
          <div class="controls-row"><label style="font-size:13px;color:#6b7280;margin-right:auto">Admin hide: <input type="checkbox" class="admin-hide-checkbox" data-panel="attendanceRecordsPanel" style="margin-left:8px"/></label><button id="downloadCSVBtn">Download CSV</button><button id="clearAllRecordsBtn" class="secondary">Delete All</button></div>
          <div id="recordsWrap">
            <table id="recordsTable">
              <thead><tr><th>Date</th><th>Time</th><th>Lecture</th><th>Faculty</th><th>Present</th><th>View</th><th>Edit</th><th>Delete</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="panel" id="analyticsPanel" data-panel="analyticsPanel">
          <h3 class="panel-title">Attendance Analytics</h3>
          <div class="summary"><p><strong>Regular Students (Today)</strong></p><p id="studentsStatsText" class="stats-line"></p></div>
          <canvas id="studentsPie" height="110"></canvas>
          <div style="margin-top:12px">
            <div id="leaderboardWrap" class="panel" style="padding:10px;margin-top:6px" data-panel="leaderboardWrap">
              <strong>Leaderboard</strong>
              <div style="font-size:13px;color:#6b7280;margin-top:6px">Top and Bottom students by overall attendance %</div>
              <div style="margin-top:10px;overflow:auto">
                <table id="leaderboardTable" style="width:100%;border-collapse:collapse">
                  <thead>
                    <tr>
                      <th style="text-align:left;padding:8px 6px;border-bottom:1px solid #eef2f7">Rank</th>
                      <th style="text-align:left;padding:8px 6px;border-bottom:1px solid #eef2f7">Roll</th>
                      <th style="text-align:left;padding:8px 6px;border-bottom:1px solid #eef2f7">Name</th>
                      <th style="text-align:right;padding:8px 6px;border-bottom:1px solid #eef2f7">Present</th>
                      <th style="text-align:right;padding:8px 6px;border-bottom:1px solid #eef2f7">Total</th>
                      <th style="text-align:right;padding:8px 6px;border-bottom:1px solid #eef2f7">%</th>
                    </tr>
                  </thead>
                  <tbody id="leaderboardBody"></tbody>
                </table>
              </div>

              <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
                <button id="leaderTopBtn" class="record-action view" type="button">Show Top 10</button>
                <button id="leaderBottomBtn" class="record-action view" type="button">Show Bottom 10</button>
                <button id="leaderAllBtn" class="record-action view" type="button">Show All</button>
              </div>
            </div>
          </div>
        </div>
      </aside>
    </main>

    <footer>TY-BCA 2025-26 ‚Ä¢ Digital Attendance ‚Ä¢ Powered by Supabase</footer>
  </div>

  <!-- Attendance viewer modal -->
  <div id="attModalBackdrop" class="att-modal-backdrop" aria-hidden="true">
    <div class="att-modal" role="dialog" aria-modal="true" aria-labelledby="attModalTitle">
      <div class="att-modal-header">
        <div>
          <div id="attModalTitle" class="att-modal-title">Attendance</div>
          <div id="attModalSubtitle" class="att-modal-sub">Details</div>
        </div>
        <div>
          <button id="attModalCloseBtn" class="att-modal-close">Close</button>
        </div>
      </div>
      <div id="attModalContent" class="att-modal-list"></div>
    </div>
  </div>

  <!-- ========== CONFIG (SUPABASE) ========= -->
  <script>
    // Replace with your values if needed
    const SUPABASE_URL = "https://hunnkdhhacqwhpqxovte.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1bm5rZGhoYWNxd2hwcXhvdnRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MTI4MzIsImV4cCI6MjA3OTQ4ODgzMn0.MAGBD6youFiHbCVxCd_3sD4DMidEuVBFaoncj1RLxGk";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <!-- ========== MAIN JS (with Supabase persistence for admin settings) ========= -->
  <script>
    (function(){
      // state
      let currentUser = null, currentRole = null, currentList = [], attendanceState = {}, records = [], students = [], faculty = [], lectures = [], studentsPieChart = null, isEditing = false, currentEditRecordId = null, scanLog = [];

      // DOM refs (same as before)
      const loginScreen = document.getElementById("loginScreen");
      const appContainer = document.getElementById("appContainer");
      const loginEmail = document.getElementById("loginEmail");
      const loginPassword = document.getElementById("loginPassword");
      const loginSubmit = document.getElementById("loginSubmit");
      const roleLabel = document.getElementById("roleLabel");
      const logoutBtn = document.getElementById("logoutBtn");
      const attendanceDate = document.getElementById("attendanceDate");
      const userTypeSel = document.getElementById("userType");
      const searchBox = document.getElementById("searchBox");
      const sortSelect = document.getElementById("sortSelect");
      const usersTableBody = document.querySelector("#usersTable tbody");
      const selectAllBtn = document.getElementById("selectAllBtn");
      const clearAllBtn = document.getElementById("clearAllBtn");
      const scanInput = document.getElementById("scanInput");
      const lectureSelect = document.getElementById("lectureSelect");
      const lectureTypeSelect = document.getElementById("lectureType");
      const startTimeInput = document.getElementById("startTimeInput");
      const endTimeInput = document.getElementById("endTimeInput");
      const daySelect = document.getElementById("daySelect");
      const facultySelect = document.getElementById("facultySelect");
      const originalFaculty = document.getElementById("originalFaculty");
      const isProxy = document.getElementById("isProxy");
      const proxyDetails = document.getElementById("proxyDetails");
      const submitBtn = document.getElementById("submitAttendanceBtn");
      const cancelEditBtn = document.getElementById("cancelEditBtn");
      const presentCountEl = document.getElementById("presentCount");
      const absentCountEl = document.getElementById("absentCount");
      const lecturesTodayEl = document.getElementById("lecturesToday");
      const recordsTableBody = document.querySelector("#recordsTable tbody");
      const downloadCSVBtn = document.getElementById("downloadCSVBtn");
      const clearAllRecordsBtn = document.getElementById("clearAllRecordsBtn");
      const studentsStatsText = document.getElementById("studentsStatsText");
      const downloadStudentsReportCsvBtn = document.getElementById("downloadStudentsReportCsv");
      const downloadFacultyReportCsvBtn = document.getElementById("downloadFacultyReportCsv");
      const scanLogTbody = document.querySelector("#scanLogTable tbody");

      // visual containers
      const heatmapEl = document.getElementById("heatmap");
      const heatbarList = document.getElementById("heatbarList");
      const timelineEl = document.getElementById("timeline");
      const regularStudentsBody = document.getElementById("regularStudentsBody");
      const leaderboardBody = document.getElementById("leaderboardBody");

      // admin & hide config
      const ADMIN_PANEL_ID = 'adminPanel';
      const LS_KEY = 'admin_hidden_panels_v1';            // local fallback key
      const DB_KEY = 'panel_visibility';                  // admin_settings.key in DB
      const ADMIN_TABLE = 'admin_settings';               // table name

      const PANEL_MAP = [
        { key: 'attendanceReportsPanel', label: 'Attendance Reports (Visualization)', selector: '#attendanceReportsPanel' },
        { key: 'regularStudentsWrap', label: 'Regular Students (Summary)', selector: '#regularStudentsWrap' },
        { key: 'heatbarWrap', label: 'Daily Percent List', selector: '#heatbarWrap' },
        { key: 'monthlyHeatWrap', label: 'Monthly Heatmap (grid)', selector: '#monthlyHeatWrap' },
        { key: 'attendanceRecordsPanel', label: 'Attendance Records', selector: '#attendanceRecordsPanel' },
        { key: 'analyticsPanel', label: 'Attendance Analytics / Leaderboard', selector: '#analyticsPanel' }
      ];

      // init
      async function init(){
        const { data:{session} } = await supabase.auth.getSession();
        if(session) await handleSessionUser(session.user);

        // event wiring
        loginSubmit.addEventListener("click", handleLogin);
        loginPassword.addEventListener("keydown", e => { if(e.key==="Enter") handleLogin(); });
        logoutBtn.addEventListener("click", logout);
        userTypeSel.addEventListener("change", onUserTypeChange);
        searchBox.addEventListener("input", renderList);
        sortSelect.addEventListener("change", renderList);
        selectAllBtn.addEventListener("click", ()=>setAll(true));
        clearAllBtn.addEventListener("click", ()=>setAll(false));
        attendanceDate.addEventListener("change", ()=>{ updateSummary(); renderAllCharts(); renderHeatmap(); });
        isProxy.addEventListener("change", ()=>{ proxyDetails.style.display = isProxy.checked ? "block" : "none"; });
        submitBtn.addEventListener("click", submitAttendance);
        cancelEditBtn.addEventListener("click", ()=>exitEditMode(false));
        downloadCSVBtn.addEventListener("click", downloadCSV);
        clearAllRecordsBtn.addEventListener("click", clearAllRecords);
        downloadStudentsReportCsvBtn.addEventListener("click", ()=>downloadStudentsReport());
        downloadFacultyReportCsvBtn.addEventListener("click", ()=>downloadFacultyReport());
        scanInput.addEventListener("keydown", e => { if(e.key==="Enter"){ const code=scanInput.value.trim(); scanInput.value=""; handleScan(code); }});
        lectureSelect.addEventListener("change", updateTimeFromLecture);

        // leaderboard controls
        const leaderTopBtn = document.getElementById('leaderTopBtn');
        const leaderBottomBtn = document.getElementById('leaderBottomBtn');
        const leaderAllBtn = document.getElementById('leaderAllBtn');
        if(leaderTopBtn) leaderTopBtn.addEventListener('click', ()=> renderLeaderboard('top'));
        if(leaderBottomBtn) leaderBottomBtn.addEventListener('click', ()=> renderLeaderboard('bottom'));
        if(leaderAllBtn) leaderAllBtn.addEventListener('click', ()=> renderLeaderboard('all'));

        // modal hooks
        document.getElementById('attModalCloseBtn').addEventListener('click', closeAttendanceModal);
        document.getElementById('attModalBackdrop').addEventListener('click', function(e){ if(e.target===this) closeAttendanceModal(); });

        // admin actions
        document.getElementById('unhideSelected')?.addEventListener('click', unhideSelected);
        document.getElementById('unhideAll')?.addEventListener('click', unhideAll);

        // admin checkbox change (capturing)
        document.addEventListener('change', function(e){
          if(e.target && e.target.classList && e.target.classList.contains('admin-hide-checkbox')){
            const panelKey = e.target.getAttribute('data-panel');
            if(panelKey) togglePanelHidden(panelKey, e.target.checked);
          }
        });

        attendanceDate.value = new Date().toISOString().slice(0,10);

        // initial load
        await loadStudents(); await loadFaculty(); await loadLectures(); await loadAttendanceRecords();
        populateLectures(); populateFacultySelects(); updateTimeFromLecture();
        userTypeSel.value = "student"; setUserListForType(); applyRolePermissions();
        updateSummary(); renderAllCharts(); renderAttendanceReport(); renderHeatmap();

        // load visibility from DB (if possible) then apply
        await loadPanelVisibilityFromDB();
        buildAdminList();
        applyHiddenPanels();
      }

      // -------------------------
      // Persistence: Supabase DB
      // -------------------------
      async function loadPanelVisibilityFromDB(){
        // Try DB first. If fails, fallback to localStorage
        try {
          const { data, error } = await supabase
            .from(ADMIN_TABLE)
            .select('value')
            .eq('key', DB_KEY)
            .single();

          if(error && error.code !== 'PGRST116') { // PGRST116 single() empty row; handle silently
            console.warn('Error loading admin settings from DB', error);
            // fallthrough to localStorage fallback
          }

          if(data && data.value){
            // data.value is JSON stored in DB
            localStorage.setItem(LS_KEY, JSON.stringify(data.value || {}));
            return data.value;
          } else {
            // no row ‚Äî try localStorage fallback
            const ls = localStorage.getItem(LS_KEY);
            if(ls) return JSON.parse(ls);
            return {};
          }
        } catch(err){
          console.warn('DB load failed, falling back to localStorage', err);
          const ls = localStorage.getItem(LS_KEY);
          return ls ? JSON.parse(ls) : {};
        }
      }

      async function savePanelVisibilityToDB(map){
        if(!map || typeof map !== 'object') return;
        // update localStorage immediately
        localStorage.setItem(LS_KEY, JSON.stringify(map));

        // Only admin should attempt to write to DB
        if(currentRole !== 'admin') {
          console.warn('Not admin: skipping DB write for panel visibility');
          return;
        }

        try {
          // upsert the JSON into admin_settings
          const payload = { key: DB_KEY, value: map, updated_at: new Date().toISOString(), created_by: currentUser?.id || null };
          const { data, error } = await supabase.from(ADMIN_TABLE).upsert(payload, { onConflict: 'key' }).select().single();
          if(error) throw error;
          return data;
        } catch(err){
          console.error('Failed to save panel visibility to DB: ', err);
          // leave localStorage as fallback
        }
      }

      // helpers to toggle and apply
      function getHiddenMap(){
        const raw = localStorage.getItem(LS_KEY);
        try { return raw ? JSON.parse(raw) : {}; } catch(e){ return {}; }
      }
      async function togglePanelHidden(panelKey, hidden){
        const map = getHiddenMap();
        if(hidden) map[panelKey] = true; else delete map[panelKey];
        localStorage.setItem(LS_KEY, JSON.stringify(map));
        applyHiddenPanels();
        // attempt DB save (admins)
        await savePanelVisibilityToDB(map);
        buildAdminList();
      }

      function isPanelHidden(panelKey){
        const map = getHiddenMap();
        return !!map[panelKey];
      }

      function applyHiddenPanels(){
        const map = getHiddenMap();
        PANEL_MAP.forEach(p=>{
          const el = document.querySelector(p.selector);
          if(!el) return;
          const shouldHide = !!map[p.key];
          if(shouldHide && currentRole !== 'admin'){
            el.style.display = 'none';
            el.classList.add('is-hidden-panel');
          } else {
            el.style.display = '';
            el.classList.remove('is-hidden-panel');
          }
          // sync checkbox if present
          const cb = document.querySelector(`.admin-hide-checkbox[data-panel="${p.key}"]`);
          if(cb) cb.checked = !!map[p.key];
        });

        // admin panel visible only to admin
        const adminPanel = document.getElementById('adminPanel');
        if(adminPanel) adminPanel.style.display = (currentRole === 'admin') ? '' : 'none';
      }

      function buildAdminList(){
        const list = document.getElementById('adminPanelList');
        if(!list) return;
        list.innerHTML = '';
        const map = getHiddenMap();
        PANEL_MAP.forEach(p=>{
          const div = document.createElement('div');
          div.style.display = 'flex';
          div.style.justifyContent = 'space-between';
          div.style.alignItems = 'center';
          div.style.padding = '6px 0';
          const hidden = !!map[p.key];
          div.innerHTML = `<div><strong>${p.label}</strong><div style="font-size:12px;color:#6b7280">${p.selector}</div></div>
            <div style="display:flex;gap:8px;align-items:center">
              <label style="font-size:13px;color:#6b7280"><input type="checkbox" data-panel="${p.key}" class="admin-list-checkbox" ${hidden? 'checked':''}/> Hidden</label>
              <button class="record-action admin-unhide-button" data-panel="${p.key}">${hidden? 'Unhide':'Hide'}</button>
            </div>`;
          list.appendChild(div);
        });

        // wire buttons & checkboxes
        list.querySelectorAll('.admin-unhide-button').forEach(btn=>{
          btn.addEventListener('click', async function(e){
            const key = e.currentTarget.getAttribute('data-panel');
            const currentlyHidden = isPanelHidden(key);
            await togglePanelHidden(key, !currentlyHidden);
          });
        });
        list.querySelectorAll('.admin-list-checkbox').forEach(cb=>{
          cb.addEventListener('change', async function(e){
            const key = e.target.getAttribute('data-panel');
            await togglePanelHidden(key, e.target.checked);
          });
        });
      }

      function unhideSelected(){
        const list = document.getElementById('adminPanelList');
        if(!list) return;
        list.querySelectorAll('.admin-list-checkbox:checked').forEach(cb=>{
          const key = cb.getAttribute('data-panel');
          togglePanelHidden(key, false);
        });
      }
      function unhideAll(){
        PANEL_MAP.forEach(p=> togglePanelHidden(p.key, false));
      }

      // ----------------------------
      // Existing app functions (unchanged logic)
      // ----------------------------
      async function handleLogin(){
        const email = loginEmail.value.trim(), password = loginPassword.value.trim();
        if(!email||!password){ showAlert("Please enter email and password"); return; }
        try{
          const { data, error } = await supabase.auth.signInWithPassword({ email, password });
          if(error) throw error;
          await handleSessionUser(data.user);
          showAlert("‚úÖ Login successful!");
        }catch(err){ console.error(err); showAlert("‚ùå Login failed: "+(err.message||err)); }
      }

      async function handleSessionUser(user){
        try{
          const { data: userData, error } = await supabase.from("users").select("role, full_name").eq("id", user.id).single();
          if(error) throw error;
          currentUser = user; currentRole = userData.role || "student";
          await enterApp();
        }catch(err){ console.error(err); showAlert("‚ùå Error loading user data"); }
      }

      async function logout(){ await supabase.auth.signOut(); currentUser=null; currentRole=null; loginEmail.value=""; loginPassword.value=""; appContainer.style.display="none"; loginScreen.style.display="flex"; document.body.classList.remove("theme-main"); document.body.classList.add("theme-login"); }

      async function enterApp(){
        document.body.classList.remove("theme-login"); document.body.classList.add("theme-main");
        loginScreen.style.display="none"; appContainer.style.display="block";
        roleLabel.textContent = `Logged in as ${currentRole.charAt(0).toUpperCase()+currentRole.slice(1)}`;
        await loadStudents(); await loadFaculty(); await loadLectures(); await loadAttendanceRecords();
        populateLectures(); populateFacultySelects(); updateTimeFromLecture(); userTypeSel.value="student"; setUserListForType(); applyRolePermissions(); updateSummary(); renderAllCharts(); renderAttendanceReport(); renderHeatmap();
        // after login try to fetch DB visibility (so other admins' changes appear)
        await loadPanelVisibilityFromDB();
        applyHiddenPanels();
        buildAdminList();
      }

      function applyRolePermissions(){
        const canEdit = currentRole==="admin"||currentRole==="faculty";
        const canDelete = currentRole==="admin";
        submitBtn.disabled = !canEdit; selectAllBtn.disabled = !canEdit; clearAllBtn.disabled = !canEdit; clearAllRecordsBtn.disabled = !canDelete;

        // hide/show Edit/Delete columns robustly by matching header text
        const ths = document.querySelectorAll("#recordsTable thead th");
        ths.forEach(th=>{
          const t = th.textContent.trim().toLowerCase();
          if(t === "edit") th.style.display = canEdit ? "" : "none";
          if(t === "delete") th.style.display = canDelete ? "" : "none";
        });

        const adminPanelEl = document.getElementById(ADMIN_PANEL_ID);
        if(adminPanelEl) adminPanelEl.style.display = (currentRole === 'admin') ? '' : 'none';

        renderList(); renderRecords();
        applyHiddenPanels(); // ensure hidden panels are applied for non-admin users
      }

      async function loadStudents(){ try{ const { data, error } = await supabase.from("students").select("*").order("roll_no",{ascending:true}); if(error) throw error; students = data.map(s=>({roll:s.roll_no,name:s.name,id:s.id})); }catch(err){ console.error(err); showAlert("‚ùå Error loading students"); } }
      async function loadFaculty(){ try{ const { data, error } = await supabase.from("faculty").select("*").order("roll_no",{ascending:true}); if(error) throw error; faculty = data.map(f=>({roll:f.roll_no,name:f.name,id:f.id})); }catch(err){ console.error(err); showAlert("‚ùå Error loading faculty"); } }
      async function loadLectures(){ try{ const { data, error } = await supabase.from("lectures").select("*").order("name",{ascending:true}); if(error) throw error; lectures = data || []; }catch(err){ console.error(err); showAlert("‚ùå Error loading lectures"); } }
      async function loadAttendanceRecords(){ try{
          const { data, error } = await supabase.from("attendance_records").select(`*, attendance_details (student_roll, student_name, status)`).order("date",{ascending:false}).order("created_at",{ascending:false});
          if(error) throw error;
          records = data.map(r=>({
            id: r.id,
            date: r.date,
            day: r.day,
            timeSlot: r.time_slot,
            startTime: r.start_time,
            endTime: r.end_time,
            lecture: r.lecture_name,
            lectureType: r.lecture_type,
            faculty: r.faculty_name,
            proxy: r.is_proxy,
            original: r.original_faculty_name,
            presentCount: r.present_count,
            total: r.total_count,
            attendees: (r.attendance_details||[]).map(d=>({roll:d.student_roll,name:d.student_name,status:d.status}))
          }));
          renderRecords();
        }catch(err){ console.error(err); showAlert("‚ùå Error loading attendance records"); } }

      function setUserListForType(){ const type = userTypeSel.value; currentList = (type==="student"?students:faculty).map(x=>({...x})); attendanceState={}; currentList.forEach(p=>attendanceState[p.roll]={present:false}); renderList(); }
      function onUserTypeChange(){ setUserListForType(); }

      function renderList(){
        const q = searchBox.value.trim().toLowerCase(); let list = currentList.slice(); const mode = sortSelect.value;
        if(mode==="roll-asc") list.sort((a,b)=>a.roll-b.roll);
        if(mode==="roll-desc") list.sort((a,b)=>b.roll-a.roll);
        if(mode==="name-asc") list.sort((a,b)=>a.name.localeCompare(b.name));
        if(mode==="present") list = list.filter(x=>attendanceState[x.roll]&&attendanceState[x.roll].present);
        if(mode==="absent") list = list.filter(x=>!attendanceState[x.roll]||!attendanceState[x.roll].present);
        if(q) list = list.filter(x=>String(x.roll).includes(q) || x.name.toLowerCase().includes(q));
        const canEdit = currentRole==="admin" || currentRole==="faculty";
        usersTableBody.innerHTML = "";
        list.forEach(item=>{
          const tr = document.createElement("tr");
          const tdR = document.createElement("td"); tdR.textContent = item.roll;
          const tdN = document.createElement("td"); tdN.textContent = item.name;
          const tdC = document.createElement("td");
          const chk = document.createElement("input"); chk.type="checkbox"; chk.checked = !!(attendanceState[item.roll] && attendanceState[item.roll].present); chk.disabled = !canEdit;
          chk.addEventListener("change", e=>{ attendanceState[item.roll].present = e.target.checked; updateSummary(); });
          tdC.appendChild(chk);
          tr.appendChild(tdR); tr.appendChild(tdN); tr.appendChild(tdC);
          usersTableBody.appendChild(tr);
        });
        updateSummary();
      }

      function setAll(val){ const canEdit = currentRole==="admin"||currentRole==="faculty"; if(!canEdit) return; currentList.forEach(x=>attendanceState[x.roll]={present:val}); renderList(); }

      function populateLectures(){ lectureSelect.innerHTML = ""; lectures.forEach(l=>{ const opt=document.createElement("option"); opt.value=l.name; opt.textContent=l.name; lectureSelect.appendChild(opt); }); }
      function updateTimeFromLecture(){ const lecName = lectureSelect.value; const lec = lectures.find(l=>l.name===lecName); if(lec && lec.default_start_time && lec.default_end_time){ startTimeInput.value = lec.default_start_time; endTimeInput.value = lec.default_end_time; } else { startTimeInput.value=""; endTimeInput.value=""; } }
      function populateFacultySelects(){ const fill = el=>{ el.innerHTML=""; faculty.forEach(f=>{ const opt=document.createElement("option"); opt.value=f.name; opt.textContent=`${f.name} (${f.roll})`; el.appendChild(opt); }); }; fill(facultySelect); fill(originalFaculty); }

      async function submitAttendance(){
        const canEdit = currentRole==="admin"||currentRole==="faculty"; if(!canEdit){ showAlert("Only Admin and Faculty can submit attendance"); return; }
        const date = attendanceDate.value || new Date().toISOString().slice(0,10);
        const lecture = lectureSelect.value; const lectureType = lectureTypeSelect.value || "Regular"; const day = daySelect.value || "";
        const facultyName = facultySelect.value; const proxy = isProxy.checked; const original = originalFaculty.value || "";
        const startTime = startTimeInput.value || ""; const endTime = endTimeInput.value || ""; const timeSlot = startTime && endTime ? `${startTime} to ${endTime}` : "";
        const attendees = currentList.map(p=>({ roll: p.roll, name: p.name, status: attendanceState[p.roll] && attendanceState[p.roll].present ? "P" : "A" }));
        const presentCount = attendees.filter(a=>a.status==="P").length;

        try {
          let recordId = currentEditRecordId;
          if(isEditing && currentEditRecordId){
            const { error:updateError } = await supabase.from("attendance_records").update({
              date, day, time_slot: timeSlot, start_time: startTime, end_time: endTime, lecture_name: lecture, lecture_type: lectureType, faculty_name: facultyName, is_proxy: proxy, original_faculty_name: original, present_count: presentCount, total_count: attendees.length
            }).eq("id", currentEditRecordId);
            if(updateError) throw updateError;
            await supabase.from("attendance_details").delete().eq("attendance_record_id", currentEditRecordId);
          } else {
            const { data:newRecord, error:insertError } = await supabase.from("attendance_records").insert({
              date, day, time_slot: timeSlot, start_time: startTime, end_time: endTime, lecture_name: lecture, lecture_type: lectureType, faculty_name: facultyName, is_proxy: proxy, original_faculty_name: original, present_count: presentCount, total_count: attendees.length, created_by: currentUser.id
            }).select().single();
            if(insertError) throw insertError;
            recordId = newRecord.id;
          }

          const detailsToInsert = attendees.map(a=>({ attendance_record_id: recordId, student_roll: a.roll, student_name: a.name, status: a.status }));
          const { error:detailsError } = await supabase.from("attendance_details").insert(detailsToInsert);
          if(detailsError) throw detailsError;

          showAlert("‚úÖ Attendance saved successfully!");
          await loadAttendanceRecords();
          exitEditMode(true);
          updateSummary(); renderAllCharts(); renderAttendanceReport(); renderHeatmap();
        } catch(err){ console.error(err); showAlert("‚ùå Error saving attendance: "+(err.message||err)); }
      }

      function enterEditMode(recordId, record){
        isEditing = true; currentEditRecordId = recordId; submitBtn.textContent = "Update Attendance"; cancelEditBtn.style.display = "inline-flex";
        attendanceDate.value = record.date; lectureSelect.value = record.lecture; lectureTypeSelect.value = record.lectureType || "Regular"; daySelect.value = record.day || "Monday"; facultySelect.value = record.faculty || (faculty[0] && faculty[0].name);
        isProxy.checked = !!record.proxy; proxyDetails.style.display = isProxy.checked ? "block" : "none"; originalFaculty.value = record.original || facultySelect.value;
        let st = record.startTime || ""; let en = record.endTime || "";
        if((!st || !en) && record.timeSlot){ const parts = record.timeSlot.split(" to "); st = parts[0]||""; en = parts[1]||""; }
        startTimeInput.value = st; endTimeInput.value = en;
        userTypeSel.value = "student"; setUserListForType();
        currentList.forEach(p=>{ const found = (record.attendees||[]).find(a=>a.roll===p.roll); attendanceState[p.roll].present = found ? found.status==="P" : false; });
        renderList();
      }

      function exitEditMode(silent){
        isEditing = false; currentEditRecordId = null; submitBtn.textContent = "Submit Attendance"; cancelEditBtn.style.display = "none"; setUserListForType(); if(!silent) showAlert("Edit cancelled");
      }

      function renderRecords(){
        recordsTableBody.innerHTML = "";
        const canEdit = currentRole==="admin"||currentRole==="faculty";
        const canDelete = currentRole==="admin";

        records.forEach((r)=>{
          const tr = document.createElement("tr");

          // Only show the View All button if currentRole === admin
          const viewAllBtn = (currentRole === 'admin') ? `<button class="record-action view" type="button" aria-label="View all attendees">View All</button>` : '';
          const viewPresentBtn = `<button class="record-action present" type="button" aria-label="View present attendees">Present</button>`;
          const viewAbsentBtn = `<button class="record-action absent" type="button" aria-label="View absent attendees">Absent</button>`;

          const editHtml = canEdit ? `<button class="record-action edit" type="button" aria-label="Edit record">Edit</button>` : `<span style="display:inline-block;padding:6px 8px;border-radius:8px;color:#9ca3af">-</span>`;
          const deleteHtml = canDelete ? `<button class="record-action delete" type="button" aria-label="Delete record">Delete</button>` : "";

          const badgeHtml = `<span class="record-badge" aria-hidden="true">${r.presentCount || 0}/${r.total || 0}</span>`;

          tr.innerHTML =
            `<td>${escapeHtml(r.date)}</td>
             <td>${escapeHtml(r.timeSlot || "")}</td>
             <td>${escapeHtml(r.lecture)}</td>
             <td>${escapeHtml(r.faculty)}</td>
             <td>${badgeHtml}</td>
             <td class="actions">${viewAllBtn} ${viewPresentBtn} ${viewAbsentBtn}</td>
             <td style="${canEdit ? "" : "display:none;"}">${editHtml}</td>
             <td style="${canDelete ? "" : "display:none;"}">${deleteHtml}</td>`;

          recordsTableBody.appendChild(tr);

          const tdView = tr.querySelectorAll("td")[5];
          if(tdView.querySelector(".record-action.view")){
            tdView.querySelector(".record-action.view").addEventListener("click", ()=>openAttendanceModal(r,'all'));
          }
          tdView.querySelector(".record-action.present").addEventListener("click", ()=>openAttendanceModal(r,'present'));
          tdView.querySelector(".record-action.absent").addEventListener("click", ()=>openAttendanceModal(r,'absent'));

          if(canEdit){
            const editBtn = tr.querySelector(".record-action.edit");
            if(editBtn) editBtn.addEventListener("click", ()=>enterEditMode(r.id, r));
          }
          if(canDelete){
            const delBtn = tr.querySelector(".record-action.delete");
            if(delBtn) delBtn.addEventListener("click", ()=>deleteSingleRecord(r.id));
          }
        });

        applyHiddenPanels();
      }

      async function deleteSingleRecord(recordId){
        if(currentRole!=="admin") return;
        if(!confirm("Delete this record?")) return;
        try{
          const { error } = await supabase.from("attendance_records").delete().eq("id", recordId);
          if(error) throw error;
          showAlert("‚úÖ Record deleted");
          await loadAttendanceRecords(); renderAllCharts(); renderAttendanceReport(); renderHeatmap();
        }catch(err){ console.error(err); showAlert("‚ùå Error deleting record"); }
      }

      function openAttendanceModal(record, filter){
        const backdrop = document.getElementById('attModalBackdrop');
        const titleEl = document.getElementById('attModalTitle');
        const subEl = document.getElementById('attModalSubtitle');
        const content = document.getElementById('attModalContent');
        if(!record) return;
        const date = record.date||'', lecture = record.lecture||'', total = record.total || (record.attendees?record.attendees.length:0);
        let filtered = (record.attendees||[]).slice();
        if(filter==='present') filtered = filtered.filter(a=>a.status==='P');
        if(filter==='absent') filtered = filtered.filter(a=>a.status==='A');
        const count = filtered.length;
        const filterLabel = filter==='all'?'All':(filter==='present'?'Present':'Absent');

        titleEl.textContent = `${lecture || 'Lecture'} ‚Äî ${date}`;
        subEl.innerHTML = `<span class="record-meta">${filterLabel} ‚Ä¢ ${count}/${total} attendees</span>`;

        const exportBtn = `<button class="record-action" id="exportRecordCsv" type="button" aria-label="Export record CSV">Export CSV</button>`;

        if(!filtered.length){
          content.innerHTML = `<div style="margin-bottom:8px">${exportBtn}</div><div class="att-modal-empty">No records for the selected filter.</div>`;
        } else {
          let html = `<div style="margin-bottom:8px">${exportBtn}</div><table><thead><tr><th>Roll</th><th>Name</th><th>Status</th></tr></thead><tbody>`;
          filtered.forEach(a=>{ html += `<tr><td>${escapeHtml(a.roll)}</td><td>${escapeHtml(a.name)}</td><td>${a.status === 'P' ? 'P' : 'A'}</td></tr>`; });
          html += `</tbody></table>`;
          content.innerHTML = html;
        }

        const exportEl = document.getElementById('exportRecordCsv');
        if(exportEl){
          exportEl.addEventListener('click', ()=>{
            const rows = [['Roll','Name','Status']];
            filtered.forEach(a=> rows.push([a.roll, a.name, a.status]));
            const csv = rows.map(r=> r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(",")).join("\n");
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance_${record.id || 'record'}.csv`;
            a.click();
            URL.revokeObjectURL(url);
          });
        }

        backdrop.style.display = 'flex';
        backdrop.setAttribute('aria-hidden','false');
        document.querySelector('.att-modal').scrollTop = 0;
      }

      function closeAttendanceModal(){ const b = document.getElementById('attModalBackdrop'); b.style.display='none'; b.setAttribute('aria-hidden','true'); }

      async function clearAllRecords(){
        if(currentRole!=="admin"){ showAlert("Only Admin can delete all records"); return; }
        if(!confirm("Delete ALL attendance records? This cannot be undone.")) return;
        try{
          const { error } = await supabase.from("attendance_records").delete().neq("id", null);
          if(error) throw error;
          showAlert("‚úÖ All records deleted");
          await loadAttendanceRecords(); renderAllCharts(); renderAttendanceReport(); renderHeatmap();
        }catch(err){ console.error(err); showAlert("‚ùå Error deleting records"); }
      }

      function updateSummary(){
        const date = attendanceDate.value || new Date().toISOString().slice(0,10);
        const presentSet = new Set();
        records.filter(r=>r.date===date).forEach(r=>{
          (r.attendees||[]).forEach(a=>{
            if(a.status === "P") presentSet.add(a.roll);
          });
        });
        const present = presentSet.size;
        const totalStudents = students.length || 0;
        const absent = Math.max(0, totalStudents - present);
        const todays = records.filter(r=>r.date===date);

        presentCountEl.textContent = present;
        absentCountEl.textContent = absent;
        lecturesTodayEl.textContent = todays.length;
      }

      function renderAllCharts(){
        renderStudentsPie();
        renderFacultySummary();
        renderTimeline();
        renderLeaderboard('top');
        renderRegularStudentsSummary();
      }

      function renderStudentsPie(){
        const date = attendanceDate.value || new Date().toISOString().slice(0,10);
        const todays = records.filter(r=>r.date===date);
        const presentRolls = new Set();
        todays.forEach(r=>{ (r.attendees||[]).forEach(a=>{ if(a.status==='P') presentRolls.add(a.roll); }); });
        const totalStudents = students.length;
        const present = presentRolls.size;
        const absent = Math.max(0, totalStudents - present);
        const pct = totalStudents ? ((present/totalStudents)*100).toFixed(1) : "0.0";
        studentsStatsText.textContent = `Date: ${date} ‚Ä¢ Present: ${pct}%`;

        const ctx = document.getElementById("studentsPie").getContext("2d");
        if (studentsPieChart) studentsPieChart.destroy();
        studentsPieChart = new Chart(ctx, { type:'pie', data:{ labels:['Present','Absent'], datasets:[{ data:[present,absent] }] }, options:{ plugins:{ legend:{display:true,position:'bottom'}, tooltip:{ callbacks:{ label:function(ctx){ const dataArr = ctx.dataset.data; const total = dataArr.reduce((a,b)=>a+b,0)||1; const value = ctx.parsed; const p = ((value/total)*100).toFixed(1); return `${p}%`; } } } } } });
      }

      function renderFacultySummary(){
        const tbody = document.querySelector("#facultySummaryTable tbody");
        if(!tbody) return;
        const summary = {};
        faculty.forEach(f=>summary[f.name]={name:f.name,total:0,regular:0,proxy:0});
        records.forEach(r=>{ const facName = r.faculty||""; if(!facName||!summary[facName]) return; summary[facName].total++; if(r.proxy) summary[facName].proxy++; else summary[facName].regular++; });
        tbody.innerHTML = ""; Object.values(summary).forEach(row=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${row.name}</td><td>${row.total}</td><td>${row.regular}</td><td>${row.proxy}</td>`; tbody.appendChild(tr); });
      }

      function renderAttendanceReport(){ /* reserved */ }

      function renderRegularStudentsSummary(){
        if(!regularStudentsBody) return;
        const map = {};
        records.forEach(r => { (r.attendees||[]).forEach(a=>{ if(!map[a.roll]) map[a.roll] = { roll:a.roll, name:a.name, present:0, absent:0 }; if(a.status==='P') map[a.roll].present++; else map[a.roll].absent++; }); });
        students.forEach(s => { if(!map[s.roll]) map[s.roll] = { roll:s.roll, name:s.name, present:0, absent:0 }; });
        const rows = Object.values(map).sort((a,b)=>a.roll-b.roll);
        regularStudentsBody.innerHTML = "";
        rows.forEach(r=>{
          const total = r.present + r.absent;
          const pct = total ? ((r.present/total)*100).toFixed(1) : "0.0";
          const tr = document.createElement('tr');
          tr.innerHTML = `<td style="padding:8px 6px">${r.roll}</td><td style="padding:8px 6px">${escapeHtml(r.name)}</td><td style="padding:8px 6px;text-align:right">${r.present}</td><td style="padding:8px 6px;text-align:right">${r.absent}</td><td style="padding:8px 6px;text-align:right">${total}</td><td style="padding:8px 6px;text-align:right">${pct}%</td>`;
          regularStudentsBody.appendChild(tr);
        });
      }

      function renderHeatmap(){
        if(!heatmapEl) return;
        heatmapEl.innerHTML = "";
        heatbarList.innerHTML = "";
        const days = 30;
        const now = new Date(attendanceDate.value || new Date().toISOString().slice(0,10));
        const base = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const dailyPct = [];
        for(let i=days-1;i>=0;i--){
          const d = new Date(base);
          d.setDate(base.getDate() - i);
          const iso = d.toISOString().slice(0,10);
          let presentSet = new Set(), totalPossible = students.length || 0;
          records.filter(r=>r.date===iso).forEach(r=>{ (r.attendees||[]).forEach(a=>{ if(a.status==='P') presentSet.add(a.roll); }); });
          const present = presentSet.size;
          const pct = totalPossible ? Math.round((present/totalPossible)*100) : 0;
          dailyPct.push({ date: iso, pct, present });
        }
        const colorFor = pct=>{
          if(pct>=90) return "#065f46";
          if(pct>=75) return "#10b981";
          if(pct>=50) return "#84cc16";
          if(pct>=25) return "#f59e0b";
          if(pct>0) return "#f97316";
          return "#e5e7eb";
        };
        dailyPct.forEach(d=>{
          const div = document.createElement("div");
          div.className = "heatday";
          div.style.background = colorFor(d.pct);
          div.title = `${d.date}\nPresent: ${d.present} ‚Ä¢ ${d.pct}%`;
          div.textContent = d.date.slice(5).replace("-","/");
          heatmapEl.appendChild(div);
        });
        const recent = dailyPct.slice(-7).reverse();
        recent.forEach(r=>{
          const el = document.createElement('div');
          el.style.display="flex"; el.style.justifyContent="space-between"; el.style.padding="6px 4px"; el.style.alignItems="center";
          const colorBox = document.createElement('div'); colorBox.style.width="36px"; colorBox.style.height="12px"; colorBox.style.background=colorFor(r.pct); colorBox.style.borderRadius="4px";
          el.innerHTML = `<div style="font-size:13px">${r.date}</div><div style="display:flex;align-items:center;gap:8px"><div>${r.pct}%</div></div>`;
          const right = el.querySelector('div > div');
          if(right) right.replaceWith(colorBox);
          heatbarList.appendChild(el);
        });
      }

      function renderTimeline(){
        if(!timelineEl) return;
        timelineEl.innerHTML = "";
        const date = attendanceDate.value || new Date().toISOString().slice(0,10);
        const daysRecords = records.filter(r=>r.date===date).sort((a,b)=> (a.startTime||"") > (b.startTime||"") ? 1 : -1 );
        if(!daysRecords.length){ timelineEl.innerHTML = `<div class="att-modal-empty">No sessions for ${date}</div>`; return; }
        daysRecords.forEach(r=>{
          const item = document.createElement("div");
          item.className = "timeline-item";
          const label = document.createElement("div");
          label.style.width = "160px";
          label.innerHTML = `<strong>${r.timeSlot || r.startTime || ""}</strong><div style="font-size:12px;color:#6b7280">${r.lecture} ‚Ä¢ ${r.faculty}</div>`;
          const stats = document.createElement("div");
          stats.style.flex = "1";
          const pct = r.total ? Math.round((r.presentCount / r.total) * 100) : 0;
          stats.innerHTML = `<div class="bar"><div class="bar-fill" style="width:${pct}%;background:${pct>66?'#10b981':'#f59e0b'}"></div></div>`;
          const meta = document.createElement("div");
          meta.style.minWidth = "70px";
          meta.style.textAlign = "right";
          meta.innerHTML = `<div style="font-weight:600">${r.presentCount}/${r.total}</div><div style="font-size:12px;color:#6b7280">${pct}%</div>`;
          item.appendChild(label); item.appendChild(stats); item.appendChild(meta);
          timelineEl.appendChild(item);
        });
      }

      function renderLeaderboard(mode = 'top') {
        const tbody = document.getElementById('leaderboardBody');
        if(!tbody) return;
        const map = {};
        records.forEach(r=> (r.attendees||[]).forEach(a=>{ if(!map[a.roll]) map[a.roll] = { roll: a.roll, name: a.name, present:0, absent:0 }; if(a.status === "P") map[a.roll].present++; else map[a.roll].absent++; }));
        const arr = Object.values(map);
        if(!arr.length){ tbody.innerHTML = `<tr><td colspan="6" style="padding:12px;color:#6b7280">No attendance data available</td></tr>`; return; }
        arr.forEach(u => { u.total = (u.present||0) + (u.absent||0); u.pct = u.total ? (u.present / u.total * 100) : 0; });
        arr.sort((a,b) => b.pct - a.pct);
        let list;
        if(mode === 'top') list = arr.slice(0, 10);
        else if(mode === 'bottom') list = arr.slice(-10).reverse();
        else list = arr;
        let html = '';
        list.forEach((s, idx) => {
          const rank = (mode === 'bottom') ? (arr.length - (idx)) : (idx + 1);
          const pct = s.pct ? s.pct.toFixed(1) : '0.0';
          const cls = s.pct >= 75 ? 'leader-high' : (s.pct >= 25 ? 'leader-mid' : 'leader-low');
          html += `<tr>
            <td style="padding:8px 6px">${rank}</td>
            <td style="padding:8px 6px">${escapeHtml(s.roll)}</td>
            <td style="padding:8px 6px">${escapeHtml(s.name)}</td>
            <td style="padding:8px 6px;text-align:right">${s.present}</td>
            <td style="padding:8px 6px;text-align:right">${s.total}</td>
            <td style="padding:8px 6px;text-align:right" class="leader-percent ${cls}">${pct}%</td>
          </tr>`;
        });
        tbody.innerHTML = html;
      }

      async function handleScan(code){
        if(!code) return;
        const roll = parseInt(code,10); if(isNaN(roll)){ showAlert("Scan code is not a valid roll number: "+code); return; }
        const student = students.find(s=>s.roll===roll);
        if(!student){ showAlert("No student found for scanned code: "+code); return; }
        if(!attendanceState[roll]) attendanceState[roll] = { present:true }; else attendanceState[roll].present = true;
        addScanLogEntry(roll, student.name); renderList();
        try{ await supabase.from("scan_log").insert({ student_roll: roll, student_name: student.name, lecture_name: lectureSelect.value, scanned_by: currentUser.id }); }catch(err){ console.error("Error saving scan log:",err); }
      }

      function addScanLogEntry(roll,name){ const now=new Date(); const timeStr=now.toLocaleTimeString(undefined,{hour:"2-digit",minute:"2-digit"}); const lecture = lectureSelect.value; scanLog.unshift({time:timeStr,roll,name,lecture}); if(scanLog.length>50) scanLog.pop(); renderScanLog(); }
      function renderScanLog(){ if(!scanLogTbody) return; scanLogTbody.innerHTML=""; scanLog.forEach(entry=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${entry.time}</td><td>${entry.roll}</td><td>${entry.name}</td><td>${entry.lecture}</td>`; scanLogTbody.appendChild(tr); }); }

      function downloadCSV(){ const rows=[["Date","Day","Time","Lecture","LectureType","Faculty","Proxy","OriginalFaculty","Roll","Name","Status"]]; records.forEach(r=>{ r.attendees.forEach(a=>{ rows.push([r.date, r.day||"", r.timeSlot||"", r.lecture, r.lectureType||"", r.faculty||"", r.proxy ? "Yes":"No", r.original||"", a.roll, a.name, a.status]); }); }); const csv = rows.map(row=>row.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n"); const blob = new Blob([csv],{type:"text/csv;charset=utf-8;"}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download="attendance_records.csv"; a.click(); URL.revokeObjectURL(url); }

      function downloadStudentsReport(){ const map={}; records.forEach(r=>{ (r.attendees||[]).forEach(a=>{ if(!map[a.roll]) map[a.roll]={roll:a.roll,name:a.name,present:0,absent:0}; if(a.status==='P') map[a.roll].present++; else if(a.status==='A') map[a.roll].absent++; }); }); const rows=[["Roll No","Name","Total Present","Total Absent","Total Days","Attendance %"]]; Object.values(map).sort((a,b)=>a.roll-b.roll).forEach(r=>{ const totalDays=r.present+r.absent; const pct = totalDays?((r.present/totalDays)*100).toFixed(1):"0.0"; rows.push([r.roll,r.name,r.present,r.absent,totalDays,pct+"%"]); }); const csv = rows.map(row=>row.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n"); const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download="students_report.csv"; a.click(); URL.revokeObjectURL(url); }

      function downloadFacultyReport(){ const summary={}; faculty.forEach(f=>summary[f.name]={name:f.name,total:0,regular:0,proxy:0}); records.forEach(r=>{ const facName=r.faculty||""; if(!facName||!summary[facName]) return; summary[facName].total++; if(r.proxy) summary[facName].proxy++; else summary[facName].regular++; }); const rows=[["Faculty Name","Total Lectures","Regular","Proxy"]]; Object.values(summary).forEach(r=>rows.push([r.name,r.total,r.regular,r.proxy])); const csv = rows.map(row=>row.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n"); const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download="faculty_report.csv"; a.click(); URL.revokeObjectURL(url); }

      function showAlert(msg){ const div=document.createElement('div'); div.className='alert'; div.textContent = msg; appContainer.insertBefore(div,appContainer.firstChild); setTimeout(()=>div.remove(),4000); }

      function escapeHtml(str){
        if(str === null || str === undefined) return "";
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      // start
      init();
    })();
  </script>
</body>
</html>
